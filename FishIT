-- [[ MINING HUB V5.0 - STRUCTURED SEQUENCE ]]
-- Urutan: Save Pos -> Unequip -> Equip Slot 2 -> Tween Teleport -> Extract -> Delay 10s.

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Workspace = game:GetService("Workspace"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService")
}

local Player = Services.Players.LocalPlayer

-- // CONFIG
local RemoteEquip = Services.ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")
    :WaitForChild("RE/EquipToolFromHotbar")

local States = {
    AutoCrystal = false,
    AutoLava = false,
    IsMining = false
}

-- Helpers
local function GetChar() return Player.Character or Player.CharacterAdded:Wait() end
local function GetRoot() local c = Player.Character; return c and c:FindFirstChild("HumanoidRootPart") end
local function GetHum() local c = Player.Character; return c and c:FindFirstChild("Humanoid") end

-- // FUNGSI 1: LEPAS ROD (UNEQUIP)
local function Step_Unequip()
    local char = GetChar()
    local hum = GetHum()
    if not char or not hum then return end
    
    -- 1. Paksa pindah ke Backpack (Client)
    for _, t in pairs(char:GetChildren()) do
        if t:IsA("Tool") then t.Parent = Player.Backpack end
    end
    
    -- 2. Unequip Humanoid
    hum:UnequipTools()
    
    -- 3. Info Server (Unequip Slot 1)
    pcall(function() RemoteEquip:FireServer(1) end)
end

-- // FUNGSI 2: EQUIP PICKAXE (SLOT 2)
local function Step_EquipPickaxe()
    -- 1. Request Server
    pcall(function() RemoteEquip:FireServer(2) end)
    task.wait(0.5)
    
    -- 2. Cek apakah sudah terpasang?
    local char = GetChar()
    local hasTool = char:FindFirstChildWhichIsA("Tool")
    
    -- 3. Jika gagal, cari manual di tas
    if not hasTool then
        local backpack = Player.Backpack
        for _, t in pairs(backpack:GetChildren()) do
            if t:IsA("Tool") and string.find(string.lower(t.Name), "pick") then
                t.Parent = char
                break
            end
        end
    end
end

-- // FUNGSI 3: TELEPORT AMAN (TWEEN)
local function Step_Teleport(targetCFrame)
    local hrp = GetRoot()
    if not hrp then return end
    
    -- Hitung waktu agar tidak terlalu cepat (Anti-Suspicion)
    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    local speed = 60 -- Kecepatan wajar
    local time = dist / speed
    if time < 0.1 then time = 0.1 end

    local tweenInfo = TweenInfo.new(time, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    local tween = Services.TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
    
    tween:Play()
    tween.Completed:Wait() -- Tunggu sampai
    
    hrp.AssemblyLinearVelocity = Vector3.zero -- Reset fisika
end

-- // UI SETUP
if Services.CoreGui:FindFirstChild("MiniMiningUI") then Services.CoreGui.MiniMiningUI:Destroy() end
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiniMiningUI"
ScreenGui.Parent = Services.CoreGui

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 220, 0, 130)
MainFrame.Position = UDim2.new(0.5, -110, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.Text = "MINING SEQUENCE V5"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 12

-- Drag Logic
local dragging, dragInput, dragStart, startPos
local function UpdateDrag(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true; dragStart = input.Position; startPos = MainFrame.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        if dragging then UpdateDrag(input) end
    end
end)

local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Size = UDim2.new(1, 0, 0, 15)
StatusLabel.Position = UDim2.new(0, 0, 1, -15)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Ready..."
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 10

local function Notify(msg, color)
    StatusLabel.Text = msg
    StatusLabel.TextColor3 = color or Color3.fromRGB(200, 200, 200)
end

-- // BYPASS SETUP
local NoclipConn = nil
local function SetBypass(bool)
    local hrp = GetRoot()
    local hum = GetHum()
    if not hrp or not hum then return end
    if bool then
        hum.PlatformStand = true
        if not hrp:FindFirstChild("MiningFly") then
            local bv = Instance.new("BodyVelocity")
            bv.Name = "MiningFly"
            bv.Parent = hrp
            bv.MaxForce = Vector3.new(math.huge,math.huge,math.huge)
            bv.Velocity = Vector3.zero
        end
        if not NoclipConn then
            NoclipConn = Services.RunService.Stepped:Connect(function()
                if Player.Character then
                    for _,v in pairs(Player.Character:GetDescendants()) do
                        if v:IsA("BasePart") then v.CanCollide = false end
                    end
                end
            end)
        end
    else
        hum.PlatformStand = false
        if hrp:FindFirstChild("MiningFly") then hrp.MiningFly:Destroy() end
        if NoclipConn then NoclipConn:Disconnect(); NoclipConn = nil end
    end
end

-- // LOGIKA UTAMA (URUTAN BARU)
local function GetActiveNodes(folder)
    local activeList = {}
    if not folder then return activeList end
    for _, item in ipairs(folder:GetChildren()) do
        if item:IsA("Model") or item:IsA("BasePart") then
            local prompt = item:FindFirstChildWhichIsA("ProximityPrompt", true)
            if prompt and prompt.Enabled then table.insert(activeList, item) end
        end
    end
    return activeList
end

local function SmartMining(folder, toggleState)
    local activeNodes = GetActiveNodes(folder)
    if #activeNodes == 0 then return false end
    
    local hrp = GetRoot()
    if not hrp then return false end

    States.IsMining = true 

    -- ====================================================
    -- [STEP 1] SAVE POSITION
    -- ====================================================
    local SavedPosition = hrp.CFrame
    Notify("1. Position Saved", Color3.fromRGB(0, 255, 255))
    task.wait(0.5)

    -- ====================================================
    -- [STEP 2] LEPAS ROD
    -- ====================================================
    Notify("2. Unequipping Rod...", nil)
    Step_Unequip()
    task.wait(0.5)

    -- ====================================================
    -- [STEP 3] EQUIP PICKAXE SLOT 2
    -- ====================================================
    Notify("3. Equipping Pickaxe...", nil)
    Step_EquipPickaxe()
    task.wait(0.8) -- Tunggu animasi equip

    -- Cek keamanan: Pastikan Pickaxe dipegang sebelum Teleport
    local char = GetChar()
    if not char:FindFirstChildWhichIsA("Tool") then
        Notify("WARN: Equip Failed! Retrying...", Color3.fromRGB(255, 100, 0))
        Step_EquipPickaxe()
        task.wait(1)
    end
    
    -- ====================================================
    -- [STEP 4] TELEPORT TO CRYSTAL (LOOP)
    -- ====================================================
    SetBypass(true)

    for i, node in ipairs(activeNodes) do
        if not States[toggleState] then break end
        
        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            local targetCF = node:IsA("Model") and node:GetPivot() or node.CFrame
            if targetCF then
                local dest = targetCF + Vector3.new(0, 3.5, 0)
                
                -- A. TWEEN TELEPORT
                Notify("4. Going to Node " .. i, Color3.fromRGB(255, 200, 50))
                Step_Teleport(dest)
                task.wait(0.5) -- Stabilisasi
                
                -- B. EXTRACT
                fireproximityprompt(prompt)
                
                -- C. DELAY 10 DETIK (Sebelum pindah ke crystal lain)
                for cd = 10, 1, -1 do
                    if not States[toggleState] then break end
                    Notify("Wait Next... " .. cd .. "s", Color3.fromRGB(100, 255, 100))
                    task.wait(1)
                end
            end
        end
    end

    -- Selesai, pulang
    Notify("Done! Returning...", Color3.fromRGB(0, 255, 100))
    Step_Teleport(SavedPosition)
    SetBypass(false)
    
    -- Kembalikan Rod
    Step_Unequip()
    task.wait(0.3)
    pcall(function() RemoteEquip:FireServer(1) end)
    
    States.IsMining = false
    return true
end

-- // TOMBOL
local function CreateSwitch(text, stateKey, posY)
    local Btn = Instance.new("TextButton", MainFrame)
    Btn.Size = UDim2.new(0.9, 0, 0, 30)
    Btn.Position = UDim2.new(0.05, 0, 0, posY)
    Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    Btn.Text = text .. ": OFF"
    Btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    Btn.Font = Enum.Font.GothamBold
    Btn.TextSize = 11
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)
    
    Btn.MouseButton1Click:Connect(function()
        States[stateKey] = not States[stateKey]
        
        if not States[stateKey] then
             SetBypass(false) 
             States.IsMining = false
        end

        if States[stateKey] then
            Btn.Text = text .. ": ON"
            Btn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
            Btn.TextColor3 = Color3.new(1,1,1)
        else
            Btn.Text = text .. ": OFF"
            Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            Btn.TextColor3 = Color3.fromRGB(200, 200, 200)
        end
    end)
end

CreateSwitch("Auto Crystal", "AutoCrystal", 40)
CreateSwitch("Auto Lava", "AutoLava", 75)

-- // LOOPS
task.spawn(function()
    while true do
        if States.AutoCrystal then
             local Islands = Services.Workspace:FindFirstChild("Islands")
             local CryFolder = Islands and Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
             if CryFolder then
                local success = SmartMining(CryFolder, "AutoCrystal")
                if success then task.wait(5) else task.wait(2) end
             else
                Notify("Map Crystal Not Found", Color3.fromRGB(255, 50, 50))
                task.wait(2)
             end
        else
            task.wait(2)
        end
    end
end)

task.spawn(function()
    while true do
        if States.AutoLava then
            pcall(function()
                local Islands = Services.Workspace:FindFirstChild("Islands")
                local LavaFolder = Islands and Islands:FindFirstChild("Lava Basin") and Islands["Lava Basin"]:FindFirstChild("Crystals")
                if LavaFolder then
                    local success = SmartMining(LavaFolder, "AutoLava")
                    if success then task.wait(5) else task.wait(2) end
                end
            end)
        else
            task.wait(2)
        end
    end
end)
