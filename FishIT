-- ====================================================
-- [FINAL V15] PERFECT POSITION + ACTIVE STABILIZER
-- FIX: POSISI MINING PRESISI & ANTI GESER
-- ====================================================

local Services = {
    Workspace = game:GetService("Workspace"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Players = game:GetService("Players"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService"),
    RunService = game:GetService("RunService")
}

local LocalPlayer = Services.Players.LocalPlayer
local NetPath = Services.ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net

getgenv().States = {
    AutoCrystal = false,
    IsMining = false,
    IsFishing = false,
    CurrentTarget = nil, -- Menyimpan target crystal saat ini
    SavedHomeCFrame = nil
}

local Locations = {
    LavaBasin = CFrame.new(860.08, 85.86, -10094.87),
    CrystalDepths = CFrame.new(5820.14, -907.79, 15424.53)
}

-- ====================================================
-- [UI SETUP]
-- ====================================================
if game:GetService("CoreGui"):FindFirstChild("MiniMiningV15") then
    game:GetService("CoreGui").MiniMiningV15:Destroy()
end

local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local TitleLabel = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local StatusLabel = Instance.new("TextLabel")
local UICorner = Instance.new("UICorner")

if syn and syn.protect_gui then syn.protect_gui(ScreenGui) end
ScreenGui.Parent = Services.CoreGui
ScreenGui.Name = "MiniMiningV15"

MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(12, 12, 20)
MainFrame.Position = UDim2.new(0.05, 0, 0.2, 0)
MainFrame.Size = UDim2.new(0, 220, 0, 130)
MainFrame.Active = true
MainFrame.Draggable = true
UICorner.Parent = MainFrame

TitleLabel.Parent = MainFrame
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 0, 0, 5)
TitleLabel.Size = UDim2.new(1, 0, 0, 20)
TitleLabel.Font = Enum.Font.GothamBlack
TitleLabel.Text = "AUTO MINING V15 (STABLE)"
TitleLabel.TextColor3 = Color3.fromRGB(255, 170, 0)
TitleLabel.TextSize = 13

ToggleBtn.Parent = MainFrame
ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
ToggleBtn.Position = UDim2.new(0.1, 0, 0.3, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0, 35)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Text = "START"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 14
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 6)

StatusLabel.Parent = MainFrame
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0, 0, 0.7, 0)
StatusLabel.Size = UDim2.new(1, 0, 0, 15)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Text = "Status: Idle"
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.TextSize = 10

-- ====================================================
-- [CORE SYSTEM]
-- ====================================================

local function GetRoot() return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") end
local function GetHum() return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") end
local function Notify(msg, color) StatusLabel.Text = msg; StatusLabel.TextColor3 = color or Color3.fromRGB(255, 255, 255) end

local function SetAnchor(bool)
    local hrp = GetRoot()
    if hrp then 
        hrp.Anchored = bool 
        if bool then hrp.Velocity = Vector3.zero end
    end
end

-- [ACTIVE STABILIZER]
-- Fungsi ini memaksa karakter diam di tempat meskipun didorong batu
local function StabilizePosition(targetCFrame, duration)
    local sTime = tick()
    local connection
    connection = Services.RunService.RenderStepped:Connect(function()
        if not States.IsMining or (tick() - sTime > duration) then
            connection:Disconnect()
            return
        end
        local hrp = GetRoot()
        if hrp then hrp.CFrame = targetCFrame end -- Paksa posisi tetap
    end)
    return connection
end

local function EnableNoClip()
    local Connection = Services.RunService.Stepped:Connect(function()
        if not States.AutoCrystal then return end 
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") and part.CanCollide then part.CanCollide = false end
            end
        end
    end)
    return Connection
end

local function FlyTo(targetCFrame)
    local hrp = GetRoot()
    if not hrp then return end
    SetAnchor(false)
    
    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    local speed = dist > 100 and 120 or 60 -- Lebih cepat jika jauh
    local tweenInfo = TweenInfo.new(dist/speed, Enum.EasingStyle.Linear)
    
    local tween = Services.TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
    tween:Play()
    tween.Completed:Wait()
    
    hrp.CFrame = targetCFrame -- Pastikan pas di akhir
    SetAnchor(true)
end

local function EquipTool(name)
    local backpack = LocalPlayer.Backpack
    local char = LocalPlayer.Character
    local tool = char:FindFirstChild(name) or backpack:FindFirstChild(name)
    
    if not tool then
        -- Cari partial name
        for _, t in pairs(backpack:GetChildren()) do if t.Name:lower():find(name) then tool = t break end end
        if not tool then
            for _, t in pairs(char:GetChildren()) do if t.Name:lower():find(name) then tool = t break end end
        end
    end

    if tool and tool.Parent == backpack then 
        GetHum():EquipTool(tool) 
    elseif not tool then
        -- Hotbar Fallback
        local slot = (name == "pick" or name == "axe") and 2 or 1
        NetPath["RE/EquipToolFromHotbar"]:FireServer(slot)
    end
end

-- ====================================================
-- [THE PERFECT POSITION LOGIC]
-- ====================================================

local function GetMiningPosition(crystalPart)
    -- Ambil CFrame murni dari Part Crystal
    local cf = crystalPart.CFrame
    local size = crystalPart.Size
    local pos = cf.Position
    
    -- Analisa Orientasi
    local up = cf.UpVector
    local look = cf.LookVector
    local right = cf.RightVector
    
    local dotY = up:Dot(Vector3.new(0,1,0)) -- Seberapa vertikal crystalnya?
    
    local finalPos
    local lookAtPos = pos -- Titik yang dilihat oleh player
    
    -- Jarak aman dari pusat crystal (Setengah ukuran crystal + 3.5 stud)
    -- Ini mencegah karakter masuk ke dalam batu besar
    local offsetDist = (math.max(size.X, size.Y, size.Z) / 2) + 3.5

    if dotY > 0.8 then
        -- [LANTAI] Crystal di tanah -> Kita di atasnya
        finalPos = pos + Vector3.new(0, 5, 0) 
        -- Sedikit geser agar tidak tegak lurus banget (biar kamera enak)
        finalPos = finalPos + (look * 2) 
        
    elseif dotY < -0.8 then
        -- [LANGIT-LANGIT] Crystal di atas -> Kita di bawahnya
        finalPos = pos - Vector3.new(0, 6, 0)
        
    else
        -- [DINDING] Crystal miring/dinding
        -- Kita posisikan diri mengikuti arah "LookVector" (Wajah Depan) Crystal
        finalPos = pos + (look * offsetDist)
        
        -- Raycast Check (Simpel):
        -- Jika posisi target ternyata tertutup tembok lain, kita tarik mundur atau geser ke atas dikit
        local ray = Ray.new(pos, (finalPos - pos).Unit * offsetDist)
        local hit, hitPos = workspace:FindPartOnRay(ray, crystalPart)
        if hit and hit.CanCollide then
           finalPos = hitPos + Vector3.new(0, 1, 0) -- Adjust darurat
        end
    end

    -- Return CFrame: Posisi di `finalPos`, Melihat ke `pos` (pusat crystal)
    return CFrame.lookAt(finalPos, pos)
end

-- ====================================================
-- [MINING EXECUTION]
-- ====================================================

local function MineCrystal(node)
    local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
    if not prompt then return end
    
    -- 1. Hitung Posisi
    local targetCF = GetMiningPosition(prompt.Parent)
    
    -- 2. Teleport
    FlyTo(targetCF)
    
    -- 3. Kunci Posisi (Stabilizer)
    SetAnchor(true)
    local stabilizer = StabilizePosition(targetCF, 8.5) -- Kunci posisi selama 8.5 detik
    
    -- 4. Eksekusi
    task.wait(0.2)
    fireproximityprompt(prompt)
    
    -- 5. Tunggu Selesai
    local start = tick()
    repeat 
        task.wait(0.1)
    until not prompt.Parent or not prompt.Enabled or (tick() - start > 8.5)
    
    if stabilizer then stabilizer:Disconnect() end -- Lepas stabilizer
end

local function ProcessLocation(locName, folderName)
    local Islands = Services.Workspace:WaitForChild("Islands", 5)
    if not Islands then return false end

    local targetFolder
    if folderName == "Lava" then
        targetFolder = Islands:FindFirstChild("Lava Basin") and Islands["Lava Basin"]:FindFirstChild("Crystals")
    elseif folderName == "Deep" then
        targetFolder = Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
    end

    if not targetFolder then return false end

    local crystals = {}
    for _, v in pairs(targetFolder:GetChildren()) do
        if v:FindFirstChildWhichIsA("ProximityPrompt", true) then table.insert(crystals, v) end
    end

    if #crystals == 0 then return false end -- Kosong/Zonk

    Notify("Mining at "..locName.." ("..#crystals..")", Color3.fromRGB(255, 200, 0))

    -- Sort Terdekat
    local hrp = GetRoot()
    table.sort(crystals, function(a,b)
        return (a:GetPivot().Position - hrp.Position).Magnitude < (b:GetPivot().Position - hrp.Position).Magnitude
    end)

    for i, node in ipairs(crystals) do
        if not States.AutoCrystal then break end
        Notify("Mining Crystal "..i.."/"..#crystals, Color3.fromRGB(255, 255, 255))
        MineCrystal(node)
        task.wait(0.5)
    end
    return true
end

-- ====================================================
-- [FISHING & ROUTINE]
-- ====================================================

local function AutoFish()
    if States.IsMining then return end
    States.IsFishing = true
    
    -- Balik ke home jika jauh
    local hrp = GetRoot()
    if States.SavedHomeCFrame and hrp and (hrp.Position - States.SavedHomeCFrame.Position).Magnitude > 500 then
        Notify("Returning to Fishing Spot...", Color3.fromRGB(0, 255, 0))
        local tempCF = States.SavedHomeCFrame + Vector3.new(0, 2, 0) -- Sedikit di atas agar tidak stuck
        hrp.CFrame = tempCF
        task.wait(1)
    end

    Notify("Fishing...", Color3.fromRGB(0, 200, 255))
    SetAnchor(true)
    EquipTool("rod")

    while States.AutoCrystal and States.IsFishing and not States.IsMining do
        pcall(function()
            NetPath["RF/UpdateAutoFishingState"]:InvokeServer(true)
            NetPath["RF/ChargeFishingRod"]:InvokeServer()
            task.wait(1.5)
            NetPath["RF/RequestFishingMinigameStarted"]:InvokeServer(-0.99, 0.5, os.time())
            task.wait(3)
            NetPath["RF/CatchFishCompleted"]:InvokeServer()
        end)
        task.wait(0.4)
    end
end

local function FullRoutine(force)
    if States.IsMining then return end
    States.IsMining = true
    States.IsFishing = false
    
    local hrp = GetRoot()
    if not States.SavedHomeCFrame or force then States.SavedHomeCFrame = hrp.CFrame end
    
    local noclip = EnableNoClip()
    EquipTool("pick")

    -- 1. Lava Basin
    local hrp = GetRoot()
    hrp.CFrame = Locations.LavaBasin
    task.wait(2)
    local foundLava = ProcessLocation("Lava Basin", "Lava")

    -- 2. Crystal Depths
    if States.AutoCrystal then
        hrp.CFrame = Locations.CrystalDepths
        task.wait(2)
        local foundDeep = ProcessLocation("Deep Caverns", "Deep")
        
        if not foundLava and not foundDeep then
            Notify("ZONK! No Crystals Found.", Color3.fromRGB(255, 50, 50))
        end
    end

    if noclip then noclip:Disconnect() end
    States.IsMining = false
    
    -- Lanjut Fishing
    task.spawn(AutoFish)
end

-- ====================================================
-- [CONTROLS]
-- ====================================================

ToggleBtn.MouseButton1Click:Connect(function()
    States.AutoCrystal = not States.AutoCrystal
    if States.AutoCrystal then
        ToggleBtn.Text = "STOP"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
        
        local min = os.date("!*t").min
        -- Logika Waktu: Menit 00-45 Mining, 45-59 Fishing
        if min >= 0 and min <= 45 then
            Notify("Starting Mining Cycle...", Color3.fromRGB(255, 215, 0))
            task.spawn(function() FullRoutine(true) end)
        else
            Notify("Fishing Time...", Color3.fromRGB(0, 200, 255))
            if GetRoot() then States.SavedHomeCFrame = GetRoot().CFrame end
            task.spawn(AutoFish)
        end
    else
        ToggleBtn.Text = "START"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        Notify("Stopped.", Color3.fromRGB(255, 0, 0))
        States.IsMining = false
        States.IsFishing = false
        SetAnchor(false)
    end
end)

-- Background Time Check
task.spawn(function()
    while true do
        task.wait(5)
        if States.AutoCrystal and not States.IsMining then
            local min = os.date("!*t").min
            if min >= 0 and min <= 5 and States.IsFishing then
                Notify("Time to Mine!", Color3.fromRGB(255, 200, 0))
                FullRoutine(false)
            end
        end
    end
end)
