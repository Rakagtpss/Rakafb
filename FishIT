-- // ==============================================================================
-- // Seraphin Helper - Refactored & Optimized
-- // ==============================================================================

-- [1] SERVICES CACHE
local Services = {
    Players = game:GetService("Players"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    Lighting = game:GetService("Lighting"),
    TeleportService = game:GetService("TeleportService"),
    UserInputService = game:GetService("UserInputService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    TweenService = game:GetService("TweenService"),
    Workspace = game:GetService("Workspace"),
    SoundService = game:GetService("SoundService"),
    Stats = game:GetService("Stats"),
    TextChatService = game:GetService("TextChatService")
}

local LocalPlayer = Services.Players.LocalPlayer
local Camera = Services.Workspace.CurrentCamera

-- [2] NETWORK WRAPPER
local Network = {
    PackagePath = Services.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index"):WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net")
}

function Network:Fire(remoteName, ...)
    local remote = self.PackagePath:FindFirstChild(remoteName)
    if remote and remote:IsA("RemoteEvent") then
        remote:FireServer(...)
    end
end

function Network:Invoke(remoteName, ...)
    local remote = self.PackagePath:FindFirstChild(remoteName)
    if remote and remote:IsA("RemoteFunction") then
        return remote:InvokeServer(...)
    end
end

function Network:Get(remoteName)
    return self.PackagePath:FindFirstChild(remoteName)
end

-- [3] STATE MANAGEMENT
local State = {
    Freeze = false, WoW = false, Boost = false, NoRender = false, Noclip = false, 
    Panel = true, AutoEquip = false, AutoEvent = false, Speed = false, SpeedVal = 50, 
    NoDmg = false, AutoFollow = false, FollowTarget = nil, AutoCoral = false, 
    AutoFarmRelic = false, AutoMiningV20 = false, Busy = false, IsMining = false, 
    HasTank = false, RelicSel = "Blacktide", RelicSpot = 1, HideRod = false, 
    StreamerMode = false, AnimSkin = "Off", AutoFishActive = false,
    
    -- Internal Cache
    Connections = {},
    SavedCFrame = nil,
    EventStartCFrame = nil,
    CoralReturnCFrame = nil,
    IsInEvent = false,
    IsLootingCoral = false,
    BodyV = nil,
    LastFishCaughtTime = tick(),
    EventList = {"Ghost Shark Hunt", "Worm Hunt", "Treasure Hunt", "Shark Hunt", "Megalodon Hunt"},
    SavedMinePosition = nil
}

-- [4] UTILITIES
local Utils = {}

function Utils.GetChar()
    return LocalPlayer.Character
end

function Utils.GetRoot()
    local c = Utils.GetChar()
    return c and c:FindFirstChild("HumanoidRootPart")
end

function Utils.GetHum()
    local c = Utils.GetChar()
    return c and c:FindFirstChild("Humanoid")
end

function Utils.Create(className, properties)
    local instance = Instance.new(className)
    for k, v in pairs(properties or {}) do
        instance[k] = v
    end
    return instance
end

function Utils.EnableDrag(frame, dragInputObj)
    local dragToggle, dragStart, startPos
    
    dragInputObj.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragToggle = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragToggle = false
                end
            end)
        end
    end)
    
    dragInputObj.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            local dragInput = input
            Services.UserInputService.InputChanged:Connect(function(inputCheck)
                if inputCheck == dragInput and dragToggle then
                    local delta = inputCheck.Position - dragStart
                    frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
                end
            end)
        end
    end)
end

-- [5] UI CONFIGURATION & BUILDER
local UI_THEME = {
    Width = 400,
    Height = 270,
    Color = Color3.fromRGB(12, 12, 14),
    SidebarColor = Color3.fromRGB(8, 8, 8),
    SidebarTransparency = 0.5,
    Transparency = 0.15,
    Accent = Color3.fromRGB(255, 255, 255),
    TextMain = Color3.fromRGB(240, 240, 240),
    TextDim = Color3.fromRGB(160, 160, 170),
    FontUI = Enum.Font.GothamBlack,
    FontBtn = Enum.Font.GothamBold,
    CornerRadius = UDim.new(0, 10)
}

if Services.CoreGui:FindFirstChild("SeraphinHelper") then
    Services.CoreGui.SeraphinHelper:Destroy()
end

local ScreenGui = Utils.Create("ScreenGui", {
    Name = "SeraphinHelper",
    Parent = Services.CoreGui,
    ResetOnSpawn = false,
    ZIndexBehavior = Enum.ZIndexBehavior.Sibling
})

-- Notifications
local NotifyContainer = Utils.Create("Frame", {
    Name = "NotificationContainer",
    Parent = ScreenGui,
    Size = UDim2.new(0, 220, 0.5, 0),
    AnchorPoint = Vector2.new(1, 1),
    Position = UDim2.new(1, -20, 1, -20),
    BackgroundTransparency = 1,
    ClipsDescendants = false
})

Utils.Create("UIListLayout", {
    Parent = NotifyContainer,
    FillDirection = Enum.FillDirection.Vertical,
    VerticalAlignment = Enum.VerticalAlignment.Bottom,
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 5)
})

local function Notify(title, text, colorOverride, duration)
    local color = colorOverride or Color3.fromRGB(200, 200, 200)
    local timeTime = duration or 3
    
    local Frame = Utils.Create("Frame", {
        Name = "NotifyItem",
        Parent = NotifyContainer,
        Size = UDim2.new(1, 0, 0, 0),
        BackgroundColor3 = Color3.fromRGB(18, 18, 22),
        BackgroundTransparency = 0.1,
        BorderSizePixel = 0
    })
    Utils.Create("UICorner", {Parent = Frame, CornerRadius = UDim.new(0, 6)})
    
    Utils.Create("Frame", {
        Parent = Frame,
        Size = UDim2.new(0, 3, 1, -10),
        Position = UDim2.new(0, 0, 0, 5),
        BackgroundColor3 = color,
        BorderSizePixel = 0
    }):Clone().Parent = Frame -- Quick corner handling inside Create isn't possible, manually add
    Utils.Create("UICorner", {Parent = Frame:GetChildren()[2], CornerRadius = UDim.new(0, 4)})

    local LblTitle = Utils.Create("TextLabel", {
        Parent = Frame,
        Size = UDim2.new(1, -15, 0, 14),
        Position = UDim2.new(0, 10, 0, 6),
        BackgroundTransparency = 1,
        Text = string.upper(title),
        TextColor3 = color,
        Font = UI_THEME.FontUI,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local LblMsg = Utils.Create("TextLabel", {
        Parent = Frame,
        Size = UDim2.new(1, -15, 0, 14),
        Position = UDim2.new(0, 10, 0, 20),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = UI_THEME.TextMain,
        Font = Enum.Font.GothamMedium,
        TextSize = 10,
        TextXAlignment = Enum.TextXAlignment.Left
    })

    Services.TweenService:Create(Frame, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = UDim2.new(1, 0, 0, 40)}):Play()
    
    task.delay(timeTime, function()
        if Frame then
            local TweenOut = Services.TweenService:Create(Frame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
                Size = UDim2.new(1, 20, 0, 0),
                BackgroundTransparency = 1
            })
            TweenOut:Play()
            if LblTitle then Services.TweenService:Create(LblTitle, TweenInfo.new(0.2), {TextTransparency = 1}):Play() end
            if LblMsg then Services.TweenService:Create(LblMsg, TweenInfo.new(0.2), {TextTransparency = 1}):Play() end
            TweenOut.Completed:Wait()
            Frame:Destroy()
        end
    end)
end

Notify("SERAPHIN", "V30 Mining 2.5H (Optimized)", nil, 4)

-- Monitor HUD
local MonitorHUD = Utils.Create("Frame", {
    Name = "LiveMonitor", Parent = ScreenGui, Size = UDim2.new(0, 180, 0, 24),
    Position = UDim2.new(0.5, -90, 0, 10), BackgroundColor3 = Color3.fromRGB(15, 15, 18),
    BackgroundTransparency = 0.2, BorderSizePixel = 0, Active = true
})
Utils.Create("UICorner", {Parent = MonitorHUD, CornerRadius = UDim.new(0, 6)})

local MonLabel = Utils.Create("TextLabel", {
    Parent = MonitorHUD, Size = UDim2.new(1, 0, 1, 0), BackgroundTransparency = 1,
    Text = "FPS: -- | CPU: --.-- | TIME: --:--:--", TextColor3 = Color3.fromRGB(255, 255, 255),
    Font = UI_THEME.FontUI, TextSize = 10
})
Utils.EnableDrag(MonitorHUD, MonitorHUD)

-- Float HUD
local FloatHUD = Utils.Create("Frame", {
    Name = "FloatingStats", Parent = ScreenGui, AnchorPoint = Vector2.new(0.5, 0),
    Size = UDim2.new(0, 150, 0, 100), Position = UDim2.new(0.5, 0, 0.35, 0),
    BackgroundColor3 = Color3.fromRGB(15, 15, 18), BackgroundTransparency = 0.3,
    BorderSizePixel = 0, Visible = false, Active = true
})
Utils.Create("UICorner", {Parent = FloatHUD, CornerRadius = UDim.new(0, 8)})
Utils.Create("UIListLayout", {
    Parent = FloatHUD, FillDirection = Enum.FillDirection.Vertical,
    HorizontalAlignment = Enum.HorizontalAlignment.Center, VerticalAlignment = Enum.VerticalAlignment.Top,
    SortOrder = Enum.SortOrder.LayoutOrder
})
Utils.Create("UIPadding", {
    Parent = FloatHUD, PaddingTop = UDim.new(0, 8), PaddingBottom = UDim.new(0, 8),
    PaddingLeft = UDim.new(0, 8), PaddingRight = UDim.new(0, 8)
})

local TitleLabel = Utils.Create("TextLabel", {
    Parent = FloatHUD, LayoutOrder = 1, Size = UDim2.new(1, 0, 0, 18),
    BackgroundTransparency = 1, Text = "PANEL SERAPHIN", TextColor3 = Color3.fromRGB(255, 255, 255),
    Font = UI_THEME.FontUI, TextSize = 12, TextStrokeTransparency = 1
})
Utils.Create("Frame", {
    Parent = FloatHUD, LayoutOrder = 2, Size = UDim2.new(1, 0, 0, 1),
    BackgroundColor3 = UI_THEME.TextDim, BackgroundTransparency = 0.8, BorderSizePixel = 0
})

local function CreateStatBlock(titleText, defaultVal, order)
    local Block = Utils.Create("Frame", {
        Name = titleText.."Block", Parent = FloatHUD, LayoutOrder = order,
        Size = UDim2.new(1, 0, 0, 28), BackgroundTransparency = 1, BorderSizePixel = 0
    })
    Utils.Create("TextLabel", {
        Name = "Title", Parent = Block, Size = UDim2.new(1, 0, 0, 12), Position = UDim2.new(0, 0, 0, 2),
        BackgroundTransparency = 1, Text = string.upper(titleText), TextColor3 = UI_THEME.TextDim,
        Font = Enum.Font.GothamBold, TextSize = 9
    })
    return Utils.Create("TextLabel", {
        Name = "Value", Parent = Block, Size = UDim2.new(1, 0, 0, 14), Position = UDim2.new(0, 0, 0, 12),
        BackgroundTransparency = 1, Text = defaultVal, TextColor3 = UI_THEME.TextMain,
        Font = UI_THEME.FontUI, TextSize = 12
    })
end

local LblFishVal = CreateStatBlock("FISH CAUGHT", "Loading...", 3)
local LblInvVal  = CreateStatBlock("INVENTORY", "0 / 0", 4)
Utils.EnableDrag(FloatHUD, FloatHUD)

-- Main UI
local Main = Utils.Create("Frame", {
    Name = "Main", Parent = ScreenGui, Size = UDim2.new(0, UI_THEME.Width, 0, UI_THEME.Height),
    Position = UDim2.new(0, 50, 0.5, -UI_THEME.Height/2), BackgroundColor3 = UI_THEME.Color,
    BackgroundTransparency = UI_THEME.Transparency, Active = true, ClipsDescendants = true,
    Visible = false, BorderSizePixel = 0
})
local MainCorner = Utils.Create("UICorner", {Parent = Main, CornerRadius = UI_THEME.CornerRadius})

local LogoContainer = Utils.Create("Frame", {
    Name = "LogoContainer", Parent = Main, Size = UDim2.new(0, 32, 0, 32),
    Position = UDim2.new(0.5, -16, 0.5, -16), BackgroundColor3 = Color3.fromRGB(20, 20, 20),
    BorderSizePixel = 0, Visible = false, ZIndex = 11
})
Utils.Create("UICorner", {Parent = LogoContainer, CornerRadius = UDim.new(0, 8)})

local LogoR = Utils.Create("TextButton", {
    Name = "LogoBtn", Parent = LogoContainer, Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1, Text = "H", TextColor3 = Color3.new(1,1,1),
    Font = UI_THEME.FontUI, TextSize = 18, ZIndex = 12
})

local Header = Utils.Create("Frame", {
    Name = "Header", Parent = Main, Size = UDim2.new(1, 0, 0, 32),
    BackgroundColor3 = UI_THEME.SidebarColor, BackgroundTransparency = UI_THEME.SidebarTransparency,
    BorderSizePixel = 0
})
Utils.Create("TextLabel", {
    Parent = Header, Size = UDim2.new(1, -40, 1, 0), Position = UDim2.new(0, 12, 0, 0),
    Text = "SERA <font color=\"rgb(255, 255, 255)\">HELPER</font>", RichText = true,
    TextColor3 = UI_THEME.TextMain, Font = UI_THEME.FontUI, TextSize = 12,
    BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left
})

local HideBtn = Utils.Create("TextButton", {
    Parent = Header, Size = UDim2.new(0, 22, 0, 22), Position = UDim2.new(1, -28, 0.5, -11),
    Text = "_", BackgroundColor3 = Color3.fromRGB(255, 255, 255), BackgroundTransparency = 0.95,
    TextColor3 = UI_THEME.TextDim, Font = UI_THEME.FontUI, TextSize = 14, AutoButtonColor = true
})
Utils.Create("UICorner", {Parent = HideBtn, CornerRadius = UDim.new(0, 6)})

Utils.EnableDrag(Main, Main)
Utils.EnableDrag(Main, LogoR)

-- Sidebar Navigation
local ContentContainer = Utils.Create("Frame", {
    Name = "Container", Parent = Main, Size = UDim2.new(1, 0, 1, -32),
    Position = UDim2.new(0, 0, 0, 32), BackgroundTransparency = 1, BorderSizePixel = 0
})

local Sidebar = Utils.Create("Frame", {
    Name = "Sidebar", Parent = ContentContainer, Size = UDim2.new(0, 95, 1, 0),
    BackgroundColor3 = UI_THEME.SidebarColor, BackgroundTransparency = UI_THEME.SidebarTransparency,
    BorderSizePixel = 0
})
Utils.Create("UIListLayout", {
    Parent = Sidebar, FillDirection = Enum.FillDirection.Vertical, SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 5), HorizontalAlignment = Enum.HorizontalAlignment.Center
})
Utils.Create("UIPadding", {Parent = Sidebar, PaddingTop = UDim.new(0, 8)})

local function CreateSideTab(name, text, isActive)
    local btn = Utils.Create("TextButton", {
        Name = name, Parent = Sidebar, Size = UDim2.new(0.85, 0, 0, 26),
        BackgroundColor3 = isActive and Color3.fromRGB(40, 40, 50) or Color3.fromRGB(255, 255, 255),
        BackgroundTransparency = isActive and 0.3 or 1,
        TextColor3 = isActive and Color3.new(1,1,1) or UI_THEME.TextDim,
        Text = text, Font = UI_THEME.FontBtn, TextSize = 10, AutoButtonColor = true, BorderSizePixel = 0
    })
    Utils.Create("UICorner", {Parent = btn, CornerRadius = UDim.new(0, 6)})
    return btn
end

local TabMainBtn   = CreateSideTab("TabMain", "MAIN", true)
local TabCharmBtn  = CreateSideTab("TabCharm", "SHOP", false)
local TabEventBtn  = CreateSideTab("TabEvent", "EVENT", false)
local TabPlayerBtn = CreateSideTab("TabPlayer", "PLAYER", false)
local TabMiscBtn   = CreateSideTab("TabMisc", "MISC", false)

local PageArea = Utils.Create("Frame", {
    Name = "PageArea", Parent = ContentContainer, Size = UDim2.new(1, -105, 1, -10),
    Position = UDim2.new(0, 100, 0, 5), BackgroundTransparency = 1, BorderSizePixel = 0, ClipsDescendants = true
})

local function CreatePage(name, visible, isList)
    local pg = Utils.Create("ScrollingFrame", {
        Name = name, Parent = PageArea, Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1, ScrollBarThickness = 2, ScrollBarImageColor3 = Color3.new(1,1,1),
        ScrollBarImageTransparency = 0.5, CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y, Visible = visible, BorderSizePixel = 0
    })
    
    if isList then
        Utils.Create("UIListLayout", {Parent = pg, Padding = UDim.new(0, 5), SortOrder = Enum.SortOrder.LayoutOrder})
    else
        Utils.Create("UIGridLayout", {
            Parent = pg, CellSize = UDim2.new(0.48, 0, 0, 26), CellPadding = UDim2.new(0, 5, 0, 5),
            SortOrder = Enum.SortOrder.LayoutOrder
        })
    end
    return pg
end

local PageMain   = CreatePage("PageMain", true, false)
local PageCharm  = CreatePage("PageCharm", false, true)
local PageEvent  = CreatePage("PageEvent", false, true)
local PagePlayer = CreatePage("PagePlayer", false, true)
local PageMisc   = CreatePage("PageMisc", false, true)

local function SwitchTab(tabName)
    local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
    local tabs = {Main = TabMainBtn, Charm = TabCharmBtn, Event = TabEventBtn, Player = TabPlayerBtn, Misc = TabMiscBtn}
    local pages = {Main = PageMain, Charm = PageCharm, Event = PageEvent, Player = PagePlayer, Misc = PageMisc}
    
    for name, btn in pairs(tabs) do
        local isActive = (name == tabName)
        pages[name].Visible = isActive
        
        Services.TweenService:Create(btn, tweenInfo, {
            BackgroundTransparency = isActive and 0.3 or 1,
            TextColor3 = isActive and Color3.new(1,1,1) or UI_THEME.TextDim,
            BackgroundColor3 = isActive and Color3.fromRGB(40, 40, 50) or Color3.fromRGB(255,255,255)
        }):Play()
    end
end

TabMainBtn.MouseButton1Click:Connect(function() SwitchTab("Main") end)
TabCharmBtn.MouseButton1Click:Connect(function() SwitchTab("Charm") end)
TabEventBtn.MouseButton1Click:Connect(function() SwitchTab("Event") end)
TabPlayerBtn.MouseButton1Click:Connect(function() SwitchTab("Player") end)
TabMiscBtn.MouseButton1Click:Connect(function() SwitchTab("Misc") end)

local IsMinimized = false
HideBtn.MouseButton1Click:Connect(function()
    if not IsMinimized then
        IsMinimized = true
        Header.Visible = false
        ContentContainer.Visible = false
        Main:TweenSize(UDim2.new(0, 36, 0, 36), "Out", "Back", 0.4, true)
        Services.TweenService:Create(MainCorner, TweenInfo.new(0.4), {CornerRadius = UDim.new(0, 10)}):Play()
        Services.TweenService:Create(Main, TweenInfo.new(0.4), {BackgroundTransparency = 0.1}):Play()
        task.delay(0.2, function() if IsMinimized then LogoContainer.Visible = true end end)
    end
end)

LogoR.MouseButton1Click:Connect(function()
    if IsMinimized then
        IsMinimized = false
        LogoContainer.Visible = false
        Main:TweenSize(UDim2.new(0, UI_THEME.Width, 0, UI_THEME.Height), "Out", "Back", 0.4, true)
        Services.TweenService:Create(MainCorner, TweenInfo.new(0.4), {CornerRadius = UI_THEME.CornerRadius}):Play()
        Services.TweenService:Create(Main, TweenInfo.new(0.4), {BackgroundTransparency = UI_THEME.Transparency}):Play()
        task.delay(0.3, function() if not IsMinimized then Header.Visible = true; ContentContainer.Visible = true end end)
    end
end)

-- UI Control Builders
local function MakeBtn(parent, text)
    local b = Utils.Create("TextButton", {
        Parent = parent, Text = text, BackgroundColor3 = Color3.fromRGB(30, 30, 40),
        BackgroundTransparency = 0.3, TextColor3 = UI_THEME.TextMain, Font = UI_THEME.FontBtn,
        TextScaled = true, BorderSizePixel = 0, AutoButtonColor = true, ClipsDescendants = true,
        TextStrokeTransparency = 1
    })
    
    if parent == PageMisc or parent == PageEvent or parent == PageCharm then
        b.Size = UDim2.new(0.95, 0, 0, 26)
    end
    
    Utils.Create("UITextSizeConstraint", {Parent = b, MaxTextSize = 10, MinTextSize = 8})
    Utils.Create("UICorner", {Parent = b, CornerRadius = UDim.new(0, 6)})
    return b
end

local function MakeSwitch(parent, text, defaultState, callback)
    local Frame = Utils.Create("Frame", {
        Name = "Switch_" .. text, Parent = parent, BackgroundColor3 = Color3.fromRGB(30, 30, 40),
        BackgroundTransparency = 0.3, BorderSizePixel = 0
    })
    
    if parent == PagePlayer or parent == PageMisc or parent == PageEvent or parent == PageCharm then
        Frame.Size = UDim2.new(0.95, 0, 0, 26)
    end
    
    Utils.Create("UICorner", {Parent = Frame, CornerRadius = UDim.new(0, 6)})
    Utils.Create("TextLabel", {
        Parent = Frame, Size = UDim2.new(0.65, 0, 1, 0), Position = UDim2.new(0, 8, 0, 0),
        BackgroundTransparency = 1, Text = text, TextColor3 = UI_THEME.TextMain,
        Font = UI_THEME.FontBtn, TextSize = 9, TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local ToggleBtn = Utils.Create("TextButton", {
        Parent = Frame, Size = UDim2.new(0, 28, 0, 14), Position = UDim2.new(1, -34, 0.5, -7),
        BackgroundColor3 = defaultState and Color3.fromRGB(0, 200, 255) or Color3.fromRGB(50, 50, 60),
        AutoButtonColor = false, Text = ""
    })
    Utils.Create("UICorner", {Parent = ToggleBtn, CornerRadius = UDim.new(1, 0)})
    
    local Circle = Utils.Create("Frame", {
        Parent = ToggleBtn, Size = UDim2.new(0, 10, 0, 10),
        Position = defaultState and UDim2.new(1, -12, 0.5, -5) or UDim2.new(0, 2, 0.5, -5),
        BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    })
    Utils.Create("UICorner", {Parent = Circle, CornerRadius = UDim.new(1, 0)})
    
    local IsOn = defaultState
    local Debounce = false
    
    ToggleBtn.MouseButton1Click:Connect(function()
        if Debounce then return end
        Debounce = true
        IsOn = not IsOn
        
        local tw = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        Services.TweenService:Create(ToggleBtn, tw, {BackgroundColor3 = IsOn and Color3.fromRGB(0, 200, 255) or Color3.fromRGB(50, 50, 60)}):Play()
        Services.TweenService:Create(Circle, tw, {Position = IsOn and UDim2.new(1, -12, 0.5, -5) or UDim2.new(0, 2, 0.5, -5)}):Play()
        
        if callback then callback(IsOn) end
        task.wait(0.2)
        Debounce = false
    end)
    return Frame
end

local function ToggleVisual(btn, on)
    Services.TweenService:Create(btn, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        TextColor3 = on and Color3.new(255,255,255) or UI_THEME.TextMain,
        BackgroundTransparency = on and 0.2 or 0.3,
        BackgroundColor3 = on and Color3.fromRGB(40, 40, 50) or Color3.fromRGB(30, 30, 40)
    }):Play()
end

-- [6] CORE FEATURES & LOGIC
local function ForceEquipRod(slot)
    pcall(function() Network:Fire("RE/EquipToolFromHotbar", slot or 1) end)
end

local function StartAutoFishRoutine()
    if State.AutoFishActive then return end
    State.AutoFishActive = true
    Notify("FISHING", "Auto Fishing Started!", Color3.fromRGB(0, 255, 255))
    
    task.spawn(function()
        while State.AutoFishActive and not State.IsMining do
            pcall(function()
                Network:Invoke("RF/UpdateAutoFishingState", true)
                Network:Invoke("RF/ChargeFishingRod")
                task.wait(1)
                Network:Invoke("RF/RequestFishingMinigameStarted", -0.9879989624023438, 0.5, 1771061230.063116)
                task.wait(2.5)
                Network:Invoke("RF/CatchFishCompleted")
            end)
            task.wait(0.5)
        end
    end)
end

local function NukeVisuals(tool)
    task.wait()
    for _, obj in ipairs(tool:GetDescendants()) do
        if obj:IsA("ParticleEmitter") or obj:IsA("Trail") or obj:IsA("Beam") or obj:IsA("Light") or obj:IsA("Fire") or obj:IsA("Sparkles") then
            obj:Destroy()
        elseif obj:IsA("BasePart") or obj:IsA("MeshPart") or obj:IsA("UnionOperation") then
            obj.Transparency = 1
            obj.CanCollide = false
            obj.CastShadow = false
        elseif obj:IsA("Texture") or obj:IsA("Decal") then
            obj.Transparency = 1
        end
    end
end

local function SetHideRod(bool)
    State.HideRod = bool
    
    if State.HideRod then
        local char = Utils.GetChar()
        if char then
            local t = char:FindFirstChild("!!!EQUIPPED_TOOL!!!") or char:FindFirstChildWhichIsA("Tool")
            if t then NukeVisuals(t) end
            
            if State.Connections.GhostRod then State.Connections.GhostRod:Disconnect() end
            State.Connections.GhostRod = char.ChildAdded:Connect(function(child)
                if State.HideRod and (child:IsA("Tool") or child.Name == "!!!EQUIPPED_TOOL!!!") then
                    NukeVisuals(child)
                    child.DescendantAdded:Connect(function(descendant)
                        if State.HideRod then
                            task.wait()
                            if descendant:IsA("BasePart") then descendant.Transparency = 1 end
                            if descendant:IsA("ParticleEmitter") then descendant:Destroy() end
                        end
                    end)
                end
            end)
        end
        Notify("MAIN", "Hide Rod: ON (Re-Equip)", nil)
    else
        if State.Connections.GhostRod then State.Connections.GhostRod:Disconnect() end
        Notify("MAIN", "Ghost Rod: OFF", nil)
    end
end

local function SetWoW(bool)
    State.WoW = bool
    
    if State.WoW then
        local hrp = Utils.GetRoot()
        if not hrp then return end
        if not State.BodyV then
            State.BodyV = Instance.new("BodyVelocity")
            State.BodyV.Name = "WoW_Velocity"
            State.BodyV.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            State.BodyV.Velocity = Vector3.zero
        end
        State.BodyV.Parent = hrp
        
        if State.Connections.WoW then State.Connections.WoW:Disconnect() end
        State.Connections.WoW = Services.RunService.RenderStepped:Connect(function()
            local hrpNow = Utils.GetRoot()
            local humNow = Utils.GetHum()
            if hrpNow and humNow and State.BodyV and State.BodyV.Parent then
                local moveDir = humNow.MoveDirection
                State.BodyV.Velocity = moveDir.Magnitude > 0 and Vector3.new(moveDir.X * humNow.WalkSpeed, 0, moveDir.Z * humNow.WalkSpeed) or Vector3.zero
            end
        end)
    else
        if State.Connections.WoW then State.Connections.WoW:Disconnect() end
        if State.BodyV then State.BodyV:Destroy(); State.BodyV = nil end
    end
end

local function ToggleBoost(enable)
    State.Boost = enable
    if enable then
        if setfpscap then setfpscap(999) end
        pcall(function()
            local l = Services.Lighting
            l.GlobalShadows = false
            l.FogEnd = 9e9
            l.Brightness = 2
            l.ClockTime = 14
            l.EnvironmentDiffuseScale = 0
            l.EnvironmentSpecularScale = 0
            l.Ambient = Color3.fromRGB(200, 200, 200)
            l.OutdoorAmbient = Color3.fromRGB(150, 150, 150)
            
            for _, v in ipairs(l:GetChildren()) do
                if v:IsA("PostEffect") or v:IsA("Atmosphere") or v:IsA("DepthOfField") or v:IsA("SunRays") or v:IsA("BlurEffect") or v:IsA("BloomEffect") then
                    v.Enabled = false
                end
            end
        end)
        
        local terrain = Services.Workspace:FindFirstChildOfClass("Terrain")
        if terrain then
            terrain.WaterReflectance = 0
            terrain.WaterTransparency = 1
            terrain.WaterWaveSize = 0
            terrain.WaterWaveSpeed = 0
            pcall(function() terrain.Material = Enum.Material.SmoothPlastic end)
        end
        
        local function OptimizeObject(v)
            pcall(function()
                if v:IsA("BasePart") then
                    v.Material = Enum.Material.SmoothPlastic
                    v.Reflectance = 0
                    v.CastShadow = false
                    if v:IsA("MeshPart") then v.TextureID = "" end
                    if v.Name == "Water" then v.Transparency = 1 end
                elseif v:IsA("Decal") or v:IsA("Texture") then
                    v.Transparency = 1
                elseif v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Beam") or v:IsA("Sparkles") or v:IsA("Fire") or v:IsA("Smoke") or v:IsA("Explosion") then
                    v.Enabled = false
                elseif v:IsA("PointLight") or v:IsA("SpotLight") or v:IsA("SurfaceLight") then
                    v.Enabled = false
                elseif v:IsA("Clothing") then
                    v:Destroy()
                end
            end)
        end
        
        for _, v in ipairs(Services.Workspace:GetDescendants()) do OptimizeObject(v) end
        
        if State.Connections.BoosterDynamic then State.Connections.BoosterDynamic:Disconnect() end
        State.Connections.BoosterDynamic = Services.Workspace.DescendantAdded:Connect(OptimizeObject)
        
        Notify("BOOST", "Bright & Fast Mode Active", Color3.fromRGB(0, 255, 100))
    else
        if State.Connections.BoosterDynamic then State.Connections.BoosterDynamic:Disconnect() end
        Notify("BOOST", "Optimization Disabled", nil)
    end
end

-- Streamer Mode
local OVERHEAD_HTML = '<font color="#FFFFFF"><font face="GothamBold"><b>discord.gg/getseraphin VISUAL</b></font></font>'
local function ApplyNameSpoof()
    if not State.StreamerMode then return end
    local char = LocalPlayer.Character
    if not char then return end
    
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    local overhead = hrp and hrp:WaitForChild("Overhead", 5)
    if not overhead then return end
    
    local label = overhead:FindFirstChild("Header", true) or overhead:FindFirstChildWhichIsA("TextLabel", true)
    if not label then return end
    
    label.RichText = true
    if State.Connections.NameSpoofText then State.Connections.NameSpoofText:Disconnect() end
    label.Text = OVERHEAD_HTML
    State.Connections.NameSpoofText = label:GetPropertyChangedSignal("Text"):Connect(function()
        if label.Text ~= OVERHEAD_HTML then label.Text = OVERHEAD_HTML end
    end)
end

local function EnableNameSpoof(bool)
    State.StreamerMode = bool
    if bool then
        ApplyNameSpoof()
        if State.Connections.NameSpoofChar then State.Connections.NameSpoofChar:Disconnect() end
        State.Connections.NameSpoofChar = LocalPlayer.CharacterAdded:Connect(function()
            task.wait(1)
            ApplyNameSpoof()
        end)
    else
        if State.Connections.NameSpoofChar then State.Connections.NameSpoofChar:Disconnect() end
        if State.Connections.NameSpoofText then State.Connections.NameSpoofText:Disconnect() end
    end
end

Services.TextChatService.OnIncomingMessage = function(message)
    if not State.StreamerMode then return nil end
    local properties = Instance.new("TextChatMessageProperties")
    local msgText = message.Text
    local spoofNameStr = "<font color='#00ffff'><font face=\"GothamBold\"><b>discord.gg/getseraphin VISUAL</b></font></font>"
    
    if msgText:find("caught") or msgText:find("obtained") or msgText:find("found") then
        local newText = msgText:gsub("^%S+", spoofNameStr)
        if msgText:find("%]") or msgText:find(":") then
            newText = msgText:gsub("(%S+)%s+caught", spoofNameStr .. " caught")
            newText = newText:gsub("(%S+)%s+obtained", spoofNameStr .. " obtained")
        end
        properties.Text = newText
    end
    if message.TextSource then
        properties.PrefixText = string.format("<font color='#00ffff'>[%s]:</font> ", spoofNameStr)
    end
    return properties
end

-- [7] FEATURE BINDINGS (MAIN TAB)
MakeSwitch(PageMain, "Auto Equip Rod", State.AutoEquip, function(val)
    State.AutoEquip = val
    Notify("MAIN", "Auto Equip Rod: "..(val and "ON" or "OFF"), nil)
end)
MakeSwitch(PageMain, "Hide Rod ", State.HideRod, SetHideRod)
MakeSwitch(PageMain, "Walk In Water", State.WoW, SetWoW)
MakeSwitch(PageMain, "Freeze Character", State.Freeze, function(val)
    State.Freeze = val
    local hrp = Utils.GetRoot()
    if hrp then hrp.Anchored = val end
    Notify("MAIN", "Freeze: "..(val and "ON" or "OFF"), nil)
end)
MakeSwitch(PageMain, "No Clip", State.Noclip, function(val)
    State.Noclip = val
    Notify("MAIN", "Noclip: "..(val and "ON" or "OFF"), nil)
    if State.Noclip then
        State.Connections.Noclip = Services.RunService.Stepped:Connect(function()
            local char = Utils.GetChar()
            if char then
                for _,v in ipairs(char:GetDescendants()) do
                    if v:IsA("BasePart") then v.CanCollide = false end
                end
            end
        end)
    else
        if State.Connections.Noclip then State.Connections.Noclip:Disconnect() end
    end
end)
MakeSwitch(PageMain, "CPU Booster ", State.Boost, ToggleBoost)
MakeSwitch(PageMain, "3D No Render", State.NoRender, function(val)
    State.NoRender = val
    Services.RunService:Set3dRenderingEnabled(not val)
    Notify("RENDER", "No Render: "..(val and "ON" or "OFF"), nil)
end)

-- [8] AUTOMATION ROUTINES (MINING & CORAL)
local function MiningRoutine()
    local hrp = Utils.GetRoot()
    if not hrp then return end
    
    State.SavedMinePosition = hrp.CFrame
    Notify("MINING", "Start: Position Saved.", Color3.fromRGB(255, 200, 0))
    
    local char = Utils.GetChar()
    if char then
        local tool = char:FindFirstChildWhichIsA("Tool")
        if tool then tool.Parent = LocalPlayer.Backpack end
    end
    task.wait(0.5)
    
    Network:Fire("RE/EquipToolFromHotbar", 2)
    Notify("MINING", "Equipped Pickaxe (Slot 2).", nil)
    task.wait(1.5) 
    
    local function RunZone(zoneName, tpCFrame, folderIslands, delayStart, delayBetween, sortMode)
        local r = Utils.GetRoot()
        if r then r.Velocity = Vector3.zero; r.Anchored = false; r.CFrame = tpCFrame end
        Notify("MINING", "Arrived " .. zoneName, Color3.fromRGB(255, 150, 0))
        task.wait(delayStart)
        
        local scanAgain = true
        while scanAgain and State.IsMining do
            local crystals = {}
            if folderIslands then
                 for _, v in ipairs(folderIslands:GetChildren()) do
                    if v:FindFirstChildWhichIsA("ProximityPrompt", true) then
                        table.insert(crystals, v)
                    end
                end
            end
            
            if #crystals == 0 then
                scanAgain = false
                Notify("MINING", zoneName .. " Clean. Done.", Color3.fromRGB(0, 255, 100))
            else
                Notify("MINING", "Found " .. #crystals .. " Crystals ("..sortMode..")", Color3.fromRGB(255, 255, 0))
                local myPos = Utils.GetRoot().Position
                table.sort(crystals, function(a,b)
                    local distA = (a:GetPivot().Position - myPos).Magnitude
                    local distB = (b:GetPivot().Position - myPos).Magnitude
                    return sortMode == "Far" and (distA > distB) or (distA < distB)
                end)
                
                for _, node in ipairs(crystals) do
                    if not State.IsMining then return end
                    local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
                    local part = prompt and prompt.Parent
                    local r2 = Utils.GetRoot()
                    
                    if r2 and part then
                        r2.Anchored = false
                        local dist = (r2.Position - part.Position).Magnitude
                        local tTime = math.max(0.5, dist / 60)
                        local tw = Services.TweenService:Create(r2, TweenInfo.new(tTime, Enum.EasingStyle.Linear), {CFrame = part.CFrame * CFrame.new(0,0,3)})
                        tw:Play()
                        tw.Completed:Wait()
                        
                        r2.Velocity = Vector3.zero
                        r2.Anchored = true
                        r2.CFrame = CFrame.lookAt(r2.Position, part.Position)
                        task.wait(3)
                        
                        if prompt.Parent then
                            fireproximityprompt(prompt)
                            Notify("MINING", "Extracting...", Color3.fromRGB(255, 0, 0))
                        end
                        task.wait(2 + delayBetween)
                    end
                end
                task.wait(1)
            end
        end
    end
    
    local isles = Services.Workspace:WaitForChild("Islands")
    local LavaFolder = isles:WaitForChild("Lava Basin"):WaitForChild("Crystals")
    local DeepFolder = isles:WaitForChild("Crystal Depths"):WaitForChild("Crystals")
    
    RunZone("Lava Basin", CFrame.new(860.08, 85.86, -10094.87), LavaFolder, 5, 5, "Near")
    if State.IsMining then
        Notify("MINING", "Moving to Deeps...", Color3.fromRGB(200, 0, 255))
        task.wait(5)
        RunZone("Crystal Depths", CFrame.new(5820.14, -907.79, 15424.53), DeepFolder, 5, 9, "Far")
    end
    
    Notify("MINING", "Mining Done. Returning...", Color3.fromRGB(0, 255, 0))
    State.IsMining = false 
    
    local finalRoot = Utils.GetRoot()
    if finalRoot and State.SavedMinePosition then
        finalRoot.Anchored = false
        finalRoot.Velocity = Vector3.zero
        finalRoot.CFrame = State.SavedMinePosition
    end
    
    task.wait(1)
    Network:Fire("RE/EquipToolFromHotbar", 1)
    Notify("GEAR", "Holding Rod (Idle)", nil)
end

MakeSwitch(PageEvent, "Auto Mine Lava/Crystal", State.AutoMiningV20, function(val)
    State.AutoMiningV20 = val
    if val then
        task.spawn(function()
            Notify("SYSTEM", "Auto Mine: Every 2.5 Hours", nil)
            local NextRun = 0 
            local Interval = 2.5 * 3600
            
            while State.AutoMiningV20 do
                if tick() >= NextRun and not State.IsMining then
                    State.AutoFishActive = false
                    State.IsMining = true
                    MiningRoutine()
                    State.IsMining = false
                    NextRun = tick() + Interval
                    Notify("SCHEDULE", "Next Mine at: " .. os.date("%H:%M", os.time() + Interval), Color3.fromRGB(0, 255, 255))
                end
                task.wait(5)
            end
        end)
    else
        State.IsMining = false
        State.AutoFishActive = false
        local hrp = Utils.GetRoot()
        if hrp then
            hrp.Anchored = false
            local char = Utils.GetChar()
            if char then
                for _, part in ipairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then part.CanCollide = true end
                end
            end
        end
        Notify("MINING", "Stopped Completely.", Color3.fromRGB(255, 50, 50))
    end
end)

-- [9] BACKGROUND LOOPS (Consolidated Task Processing)
task.spawn(function()
    while true do
        -- Player State Management
        pcall(function()
            local hum = Utils.GetHum()
            local hrp = Utils.GetRoot()
            
            -- Speed Control
            if State.Speed and hum then
                if hum.Sit and hum.SeatPart then
                    if hum.SeatPart.AssemblyLinearVelocity.Magnitude > 0 then
                        hum.SeatPart.AssemblyLinearVelocity = hum.SeatPart.CFrame.LookVector * State.SpeedVal
                    end
                else
                    hum.WalkSpeed = State.SpeedVal
                end
            end
            
            -- No Damage Control
            if State.NoDmg and hum and hum.Health < hum.MaxHealth then
                hum.Health = hum.MaxHealth
            end
            
            -- Follow Control
            if State.AutoFollow and State.FollowTarget and hrp then
                local tChar = State.FollowTarget.Character
                local tHRP = tChar and tChar:FindFirstChild("HumanoidRootPart")
                if tHRP then hrp.CFrame = tHRP.CFrame end
            end
            
            -- Auto Equip Background Check
            if State.AutoEquip and not State.IsMining then
                ForceEquipRod()
            end
        end)
        
        task.wait(State.Speed or State.AutoFollow and 0.1 or 1)
    end
end)

-- Status HUD Monitor Loop
task.spawn(function()
    while true do
        if State.Panel then
            pcall(function()
                local ls = LocalPlayer:FindFirstChild("leaderstats")
                local c = ls and ls:FindFirstChild("Caught") and ls.Caught.Value or 0
                LblFishVal.Text = tostring(c):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "")
                
                local bagText = "0/?"
                local bpGui = LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("Backpack")
                if bpGui then
                    local labelFound = false
                    for _, v in ipairs(bpGui:GetDescendants()) do
                        if v:IsA("TextLabel") and v.Text:find("/") then
                            bagText = v.Text
                            labelFound = true
                            break
                        end
                    end
                    if not labelFound and LocalPlayer:FindFirstChild("Backpack") then
                        bagText = tostring(#LocalPlayer.Backpack:GetChildren())
                    end
                elseif LocalPlayer:FindFirstChild("Backpack") then
                    bagText = tostring(#LocalPlayer.Backpack:GetChildren())
                end
                LblInvVal.Text = bagText
            end)
        end
        task.wait(State.Panel and 1 or 3)
    end
end)

-- Performance Monitor Hook
local fpsT = 0
Services.RunService.RenderStepped:Connect(function(dt)
    fpsT = fpsT + (1/dt - fpsT) * 0.1
    if MonLabel then
        MonLabel.Text = string.format("FPS: %d | CPU: %.2f ms | TIME: %s", 
            math.floor(fpsT), Services.Stats.PerformanceStats.CPU:GetValue(), 
            DateTime.now():FormatUniversalTime("HH:mm:ss", "en-us")
        )
    end
end)

-- Final Execution Overrides
task.spawn(function() if setfpscap then setfpscap(9999) end end)
task.delay(1, function()
    Main.Visible = true
    FloatHUD.Visible = State.Panel
end)

-- // End of Optimized Code