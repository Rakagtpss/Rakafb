-- [[ MINI MINING HUB V4.5 - FAST ROD RETURN ]]
-- Logika: Unequip Rod -> Equip Pickaxe -> Mine -> Wait 7s -> Selesai -> Langsung Equip Rod (Slot 1)

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Workspace = game:GetService("Workspace"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService")
}

local Player = Services.Players.LocalPlayer

-- // 1. CONFIG REMOTE
local NetPath = Services.ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")

local RemoteEquip = NetPath:WaitForChild("RE/EquipToolFromHotbar")
local RemoteUnequip = NetPath:WaitForChild("RE/UnequipToolFromHotbar")

local States = {
    AutoCrystal = false,
    AutoLava = false,
    IsMining = false
}

-- Fungsi Character
local function GetChar() return Player.Character or Player.CharacterAdded:Wait() end
local function GetRoot() local c = Player.Character; return c and c:FindFirstChild("HumanoidRootPart") end
local function GetHum() local c = Player.Character; return c and c:FindFirstChild("Humanoid") end

-- // 2. FORCE SWAP (ROD -> PICKAXE)
local function ForceSwapToPickaxe()
    local char = GetChar()
    local hum = GetHum()
    if not char or not hum then return end

    -- Lepas Rod (Slot 1)
    pcall(function() RemoteUnequip:FireServer() end)
    hum:UnequipTools()
    task.wait(0.5)

    -- Equip Pickaxe (Slot 2)
    pcall(function() RemoteEquip:FireServer(2) end)
    task.wait(0.5)

    -- Cek Manual jika gagal
    if not char:FindFirstChildWhichIsA("Tool") then
        local backpack = Player.Backpack
        for _, tool in pairs(backpack:GetChildren()) do
            if tool:IsA("Tool") and string.find(string.lower(tool.Name), "pick") then
                tool.Parent = char 
                break
            end
        end
    end
end

-- // FUNGSI KEMBALI KE ROD (UPDATED REQUEST)
local function ReturnToRod()
    local hum = GetHum()
    
    -- 1. Lepas Pickaxe dulu
    pcall(function() RemoteUnequip:FireServer() end)
    if hum then hum:UnequipTools() end
    task.wait(0.5)

    -- 2. Equip Rod (Slot 1) menggunakan Script Anda
    pcall(function()
        local args = {
            1
        }
        -- Menggunakan path lengkap sesuai request atau variabel yang sudah didefinisikan
        Services.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index"):WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/EquipToolFromHotbar"):FireServer(unpack(args))
    end)
end

-- // 3. UI SEDERHANA
if Services.CoreGui:FindFirstChild("MiniMiningUI") then Services.CoreGui.MiniMiningUI:Destroy() end
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiniMiningUI"
ScreenGui.Parent = Services.CoreGui

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 220, 0, 130)
MainFrame.Position = UDim2.new(0.5, -110, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
MainFrame.BorderSizePixel = 0
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.Text = "MINING V4.5 (DELAY 7s)"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 12

-- Drag Logic
local dragging, dragInput, dragStart, startPos
local function UpdateDrag(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true; dragStart = input.Position; startPos = MainFrame.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        if dragging then UpdateDrag(input) end
    end
end)

local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Size = UDim2.new(1, 0, 0, 15)
StatusLabel.Position = UDim2.new(0, 0, 1, -15)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Ready..."
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 10

local function Notify(msg, color)
    StatusLabel.Text = msg
    StatusLabel.TextColor3 = color or Color3.fromRGB(200, 200, 200)
end

-- // 4. BYPASS SYSTEM
local NoclipConn = nil
local function SetBypass(bool)
    local hrp = GetRoot()
    local hum = GetHum()
    if not hrp or not hum then return end

    if bool then
        hum.PlatformStand = true
        if not hrp:FindFirstChild("MiningFly") then
            local bv = Instance.new("BodyVelocity")
            bv.Name = "MiningFly"
            bv.Parent = hrp
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bv.Velocity = Vector3.zero 
        end
        if not NoclipConn then
            NoclipConn = Services.RunService.Stepped:Connect(function()
                if Player.Character then
                    for _, v in pairs(Player.Character:GetDescendants()) do
                        if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
                    end
                end
            end)
        end
    else
        hum.PlatformStand = false
        if hrp:FindFirstChild("MiningFly") then hrp.MiningFly:Destroy() end
        if NoclipConn then NoclipConn:Disconnect(); NoclipConn = nil end
    end
end

-- // 5. SAFE TWEEN
local function SafeTween(targetCFrame)
    local hrp = GetRoot()
    if not hrp then return end
    
    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    local speed = 60 
    local time = dist / speed
    if time < 0.1 then time = 0.1 end 

    local tweenInfo = TweenInfo.new(time, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    local tween = Services.TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
    
    tween:Play()
    tween.Completed:Wait()
    hrp.AssemblyLinearVelocity = Vector3.zero
end

-- // 6. LOGIKA SMART MINING (7s DELAY)
local function GetActiveNodes(folder)
    local activeList = {}
    if not folder then return activeList end
    for _, item in ipairs(folder:GetChildren()) do
        if item:IsA("Model") or item:IsA("BasePart") then
            local prompt = item:FindFirstChildWhichIsA("ProximityPrompt", true)
            if prompt and prompt.Enabled then table.insert(activeList, item) end
        end
    end
    return activeList
end

local function SmartMining(folder, toggleState)
    local activeNodes = GetActiveNodes(folder)
    if #activeNodes == 0 then return false end
    
    local hrp = GetRoot()
    if not hrp then return false end

    States.IsMining = true 
    local SafeReturnPos = hrp.CFrame
    Notify("Found " .. #activeNodes .. " Nodes", Color3.fromRGB(0, 255, 255))
    
    -- Mulai Mining: Swap ke Pickaxe
    ForceSwapToPickaxe()
    SetBypass(true)

    for i, node in ipairs(activeNodes) do
        if not States[toggleState] then break end
        
        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            local targetCF = node:IsA("Model") and node:GetPivot() or node.CFrame
            
            if targetCF then
                local dest = targetCF + Vector3.new(0, 3.5, 0)
                SafeTween(dest)
                
                Notify("Mining Node " .. i .. "/" .. #activeNodes, Color3.fromRGB(255, 200, 50))
                task.wait(0.5) 
                
                fireproximityprompt(prompt)
                
                -- DELAY DIGANTI JADI 7 DETIK
                for cd = 7, 1, -1 do
                    if not States[toggleState] then break end
                    Notify("Next in... " .. cd .. "s", Color3.fromRGB(100, 255, 100))
                    task.wait(1)
                end
            end
        end
    end

    Notify("Selesai! Pulang & Equip Rod...", Color3.fromRGB(100, 255, 100))
    SafeTween(SafeReturnPos)
    SetBypass(false)
    
    -- SELESAI MINING -> LANGSUNG EQUIP ROD
    ReturnToRod()
    
    States.IsMining = false
    return true
end

-- // 7. TOMBOL UI
local function CreateSwitch(text, stateKey, posY)
    local Btn = Instance.new("TextButton", MainFrame)
    Btn.Size = UDim2.new(0.9, 0, 0, 30)
    Btn.Position = UDim2.new(0.05, 0, 0, posY)
    Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    Btn.Text = text .. ": OFF"
    Btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    Btn.Font = Enum.Font.GothamBold
    Btn.TextSize = 11
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)
    
    Btn.MouseButton1Click:Connect(function()
        States[stateKey] = not States[stateKey]
        
        if not States[stateKey] then
             SetBypass(false) 
             States.IsMining = false
             -- Jika dimatikan paksa, kembalikan ke Rod juga
             ReturnToRod()
        end

        if States[stateKey] then
            Btn.Text = text .. ": ON"
            Btn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
            Btn.TextColor3 = Color3.new(1,1,1)
        else
            Btn.Text = text .. ": OFF"
            Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            Btn.TextColor3 = Color3.fromRGB(200, 200, 200)
        end
    end)
end

CreateSwitch("Auto Crystal", "AutoCrystal", 40)
CreateSwitch("Auto Lava", "AutoLava", 75)

-- // 8. LOOPS
task.spawn(function()
    while true do
        if States.AutoCrystal then
             local Islands = Services.Workspace:FindFirstChild("Islands")
             local CryFolder = Islands and Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
             
             if CryFolder then
                local success = SmartMining(CryFolder, "AutoCrystal")
                if success then task.wait(5) else task.wait(2) end
             else
                Notify("Map Crystal tidak ketemu!", Color3.fromRGB(255, 50, 50))
                task.wait(2)
             end
        else
            task.wait(2)
        end
    end
end)

task.spawn(function()
    while true do
        if States.AutoLava then
            pcall(function()
                local Islands = Services.Workspace:FindFirstChild("Islands")
                local LavaFolder = Islands and Islands:FindFirstChild("Lava Basin") and Islands["Lava Basin"]:FindFirstChild("Crystals")
                if LavaFolder then
                    local success = SmartMining(LavaFolder, "AutoLava")
                    if success then task.wait(5) else task.wait(2) end
                end
            end)
        else
            task.wait(2)
        end
    end
end)
