-- [[ MINI MINING HUB V5.8 - STABLE STATE & POSITION FIX ]]
-- Fix: Save Position Error, Character Check, & Force Equip Logic

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Workspace = game:GetService("Workspace"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService")
}

local Player = Services.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- // 1. UI SETUP
if Services.CoreGui:FindFirstChild("MiniMiningUI") then Services.CoreGui.MiniMiningUI:Destroy() end
if PlayerGui:FindFirstChild("MiniMiningUI") then PlayerGui.MiniMiningUI:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiniMiningUI"
pcall(function() ScreenGui.Parent = Services.CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = PlayerGui end

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 240, 0, 160)
MainFrame.Position = UDim2.new(0.5, -120, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

local Title = Instance.new("TextLabel", MainFrame)
Title.Text = "MINING V5.8 (STABLE)"
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 12

local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Text = "Ready."
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.Position = UDim2.new(0, 0, 1, -20)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
StatusLabel.Font = Enum.Font.Gotham

local function Notify(msg, color)
    StatusLabel.Text = msg
    StatusLabel.TextColor3 = color or Color3.new(1,1,1)
end

-- Dragging
local dragging, dragInput, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true; dragStart = input.Position; startPos = MainFrame.Position
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
MainFrame.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)

-- // 2. CONFIG REMOTE
local RemoteEquip = nil
pcall(function()
    RemoteEquip = Services.ReplicatedStorage:WaitForChild("Packages", 5)
        :WaitForChild("_Index", 5)
        :WaitForChild("sleitnick_net@0.2.0", 5)
        :WaitForChild("net", 5)
        :WaitForChild("RE/EquipToolFromHotbar", 5)
end)

if not RemoteEquip then
    Notify("REMOTE ERROR!", Color3.fromRGB(255, 0, 0))
else
    Notify("Idle", Color3.fromRGB(0, 255, 0))
end

-- // 3. HELPERS
local function GetChar() return Player.Character or Player.CharacterAdded:Wait() end
local function GetHum() local c = Player.Character; return c and c:FindFirstChild("Humanoid") end
local function GetRoot() local c = Player.Character; return c and c:FindFirstChild("HumanoidRootPart") end

-- Fungsi Anti Terpental (Safe Stop)
local function SafeStop()
    local hrp = GetRoot()
    local hum = GetHum()
    if not hrp or not hum then return end
    
    if hrp:FindFirstChild("MiningFly") then hrp.MiningFly:Destroy() end
    
    hrp.AssemblyLinearVelocity = Vector3.zero
    hrp.AssemblyAngularVelocity = Vector3.zero
    hum.PlatformStand = false
    
    -- Anchor sebentar untuk mematikan momentum
    hrp.Anchored = true
    task.wait(0.1)
    hrp.Anchored = false
end

-- Fungsi Tween Aman
local function SafeTween(targetCFrame)
    local hrp = GetRoot()
    if not hrp or not targetCFrame then return end -- Validasi agar tidak error
    
    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    if dist < 3 then return end
    
    local speed = 60
    local time = dist / speed
    if time < 0.1 then time = 0.1 end
    
    local ti = TweenInfo.new(time, Enum.EasingStyle.Linear)
    local tw = Services.TweenService:Create(hrp, ti, {CFrame = targetCFrame})
    tw:Play()
    tw.Completed:Wait()
    hrp.AssemblyLinearVelocity = Vector3.zero
end

-- Fungsi Cek Tool (Helpers untuk step 2 & 3)
local function IsToolEquipped()
    local char = Player.Character
    if not char then return false end
    for _,v in pairs(char:GetChildren()) do
        if v:IsA("Tool") then return true end
    end
    return false
end

-- // 4. LOGIKA UTAMA
local States = { AutoCrystal = false, AutoLava = false, IsMining = false }

local function RunMiningSequence(folder, toggleKey)
    local activeNodes = {}
    for _, v in ipairs(folder:GetChildren()) do
        if v:FindFirstChild("ProximityPrompt", true) then table.insert(activeNodes, v) end
    end
    
    if #activeNodes == 0 then return end 

    States.IsMining = true
    local hrp = GetRoot()
    local hum = GetHum()
    
    if not hrp or not hum then return end -- Cek awal

    -- Print Time
    local currentTime = os.date("%X")
    print("Nodes: " .. #activeNodes .. " | Time: " .. currentTime)
    Notify("SPAWN: " .. currentTime, Color3.fromRGB(0, 255, 255))
    task.wait(1)

    -- [STEP 1] SAVE POSITION (VALIDATED)
    local SavedPosition = nil
    if hrp then
        SavedPosition = hrp.CFrame
        Notify("1. Saving Position...", Color3.fromRGB(255, 255, 0))
    else
        Notify("Error: No Character!", Color3.fromRGB(255, 0, 0))
        States.IsMining = false
        return
    end
    task.wait(0.2)

    -- ===============================
    -- [STEP 2] FORCE UNEQUIP ALL
    -- ===============================
    Notify("2. Force Unequip...", Color3.fromRGB(255, 200, 0))

    -- Kosongkan via remote
    pcall(function() RemoteEquip:FireServer(0) end)
    if hum then hum:UnequipTools() end

    -- Tunggu sampai benar-benar kosong
    local timeout = 0
    while IsToolEquipped() and timeout < 2 do
        if hum then hum:UnequipTools() end
        pcall(function() RemoteEquip:FireServer(0) end)
        task.wait(0.2)
        timeout = timeout + 0.2
    end
    task.wait(0.3)

    -- ===============================
    -- [STEP 3] EQUIP SLOT 2 (RETRY)
    -- ===============================
    Notify("3. Equip Slot 2...", Color3.fromRGB(0, 255, 0))
    local equipped = false
    for i = 1,5 do
        pcall(function() RemoteEquip:FireServer(2) end)
        task.wait(0.4)
        if IsToolEquipped() then
            equipped = true
            break
        end
    end

    if not equipped then
        Notify("Equip Failed!", Color3.fromRGB(255,0,0))
        States.IsMining = false
        SafeStop()
        return
    end
    Notify("Slot 2 Equipped âœ“", Color3.fromRGB(0,255,120))
    task.wait(0.5)

    -- ===============================
    -- [STEP 4] TELEPORT TO CRYSTAL
    -- ===============================
    -- Re-Check Character sebelum terbang
    hrp = GetRoot()
    hum = GetHum()
    if not hrp or not hum or hum.Health <= 0 then 
        States.IsMining = false
        return 
    end

    if hum then 
        hum.PlatformStand = true 
        if not hrp:FindFirstChild("MiningFly") then
            local bv = Instance.new("BodyVelocity")
            bv.Name = "MiningFly"
            bv.Parent = hrp
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bv.Velocity = Vector3.zero
        end
    end

    for i, node in ipairs(activeNodes) do
        if not States[toggleKey] then break end
        
        -- Re-Check Character di dalam loop
        hrp = GetRoot()
        if not hrp then break end -- Stop jika mati

        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            local targetCF = node:IsA("Model") and node:GetPivot() or node.CFrame
            
            SafeTween(targetCF + Vector3.new(0, 3.5, 0))
            
            Notify("Mining Node " .. i, Color3.fromRGB(255, 170, 0))
            task.wait(0.5)
            
            -- Safety Check: Pickaxe
            if not IsToolEquipped() then
                 pcall(function() RemoteEquip:FireServer(2) end)
            end
            
            fireproximityprompt(prompt)
            
            -- Wait 7s
            for k = 7, 1, -1 do
                if not States[toggleKey] then break end
                Notify("Wait " .. k .. "s", Color3.fromRGB(100, 255, 100))
                task.wait(1)
            end
        end
    end

    -- ===============================
    -- [STEP 5] BACK TO SAVE POSITION
    -- ===============================
    hrp = GetRoot() -- Ambil HRP terbaru (takutnya respawn)
    if hrp and SavedPosition then
        Notify("Done! Back to Save Pos...", Color3.fromRGB(0, 255, 255))
        SafeTween(SavedPosition)
        SafeStop()
        Notify("Idle at Saved Pos.", Color3.fromRGB(150, 150, 150))
    else
        Notify("Pos Lost/Char Dead", Color3.fromRGB(255, 100, 100))
    end

    States.IsMining = false
end

-- // 5. UI BUTTONS
local function CreateBtn(txt, yPos, varName)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Size = UDim2.new(0.9, 0, 0, 30)
    btn.Position = UDim2.new(0.05, 0, 0, yPos)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    btn.Text = txt .. ": OFF"
    btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    
    btn.MouseButton1Click:Connect(function()
        States[varName] = not States[varName]
        if States[varName] then
            btn.Text = txt .. ": ON"
            btn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
            btn.TextColor3 = Color3.new(1,1,1)
        else
            btn.Text = txt .. ": OFF"
            btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            btn.TextColor3 = Color3.fromRGB(200, 200, 200)
            States.IsMining = false
            SafeStop()
        end
    end)
end

CreateBtn("Auto Crystal", 35, "AutoCrystal")
CreateBtn("Auto Lava", 70, "AutoLava")

-- // 6. LOOPS
task.spawn(function()
    while true do
        task.wait(1)
        if States.AutoCrystal and not States.IsMining then
            pcall(function()
                local Islands = Services.Workspace:FindFirstChild("Islands")
                local Folder = Islands and Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
                
                if Folder then
                    local ready = false
                    for _, v in ipairs(Folder:GetChildren()) do
                        local prompt = v:FindFirstChild("ProximityPrompt", true)
                        if prompt and prompt.Enabled then ready = true; break end
                    end
                    if ready then RunMiningSequence(Folder, "AutoCrystal") end
                end
            end)
        end
    end
end)

task.spawn(function()
    while true do
        task.wait(1)
        if States.AutoLava and not States.IsMining then
            pcall(function()
                local Islands = Services.Workspace:FindFirstChild("Islands")
                local Folder = Islands and Islands:FindFirstChild("Lava Basin") and Islands["Lava Basin"]:FindFirstChild("Crystals")
                
                if Folder then
                    local ready = false
                    for _, v in ipairs(Folder:GetChildren()) do
                        local prompt = v:FindFirstChild("ProximityPrompt", true)
                        if prompt and prompt.Enabled then ready = true; break end
                    end
                    if ready then RunMiningSequence(Folder, "AutoLava") end
                end
            end)
        end
    end
end)
