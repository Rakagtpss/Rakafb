-- [SETUP] Services
local Services = {
    Workspace = game:GetService("Workspace"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Players = game:GetService("Players"),
    TweenService = game:GetService("TweenService"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui")
}

local Player = Services.Players.LocalPlayer
local Camera = Services.Workspace.CurrentCamera

-- [STATE & CONFIG]
local Config = {
    Speed = 45, -- Kecepatan terbang (Studs per second). Semakin kecil semakin lambat & aman.
    DelayPerCrystal = 7, -- Delay 7 detik sesuai request
    MiningDistance = 5 -- Jarak berhenti dari crystal
}

local States = {
    AutoCrystal = false -- Default mati
}

-- [UI CREATION] Mini UI Setup
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local Corner = Instance.new("UICorner")

-- Properti UI (Mini & Compact)
ScreenGui.Name = "CrystalMiniUI"
ScreenGui.Parent = Services.CoreGui -- Masuk ke CoreGui biar tidak riset saat mati

MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.Position = UDim2.new(0.1, 0, 0.2, 0)
MainFrame.Size = UDim2.new(0, 120, 0, 60) -- Ukuran Mini
MainFrame.Active = true
MainFrame.Draggable = true -- Bisa digeser

Title.Parent = MainFrame
Title.BackgroundTransparency = 1
Title.Position = UDim2.new(0, 0, 0, 0)
Title.Size = UDim2.new(1, 0, 0, 20)
Title.Font = Enum.Font.SourceSansBold
Title.Text = "AUTO CRYSTAL"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 12

ToggleBtn.Parent = MainFrame
ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50) -- Merah (OFF)
ToggleBtn.Position = UDim2.new(0.1, 0, 0.4, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0.5, 0)
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.Text = "OFF"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 14

local btnCorner = Instance.new("UICorner")
btnCorner.CornerRadius = UDim.new(0, 5)
btnCorner.Parent = ToggleBtn

-- [UI LOGIC]
ToggleBtn.MouseButton1Click:Connect(function()
    States.AutoCrystal = not States.AutoCrystal
    if States.AutoCrystal then
        ToggleBtn.Text = "ON"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50) -- Hijau
    else
        ToggleBtn.Text = "OFF"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50) -- Merah
    end
end)

-- [HELPER FUNCTIONS]
local function GetRoot() 
    local c = Player.Character
    if not c then return nil end
    return c:FindFirstChild("HumanoidRootPart") 
end

-- Fungsi Safe Fly / Tween (Pengganti Teleport)
local function SafeFlyTo(targetCFrame)
    local hrp = GetRoot()
    if not hrp then return end
    
    local currentPos = hrp.Position
    local targetPos = targetCFrame.Position
    local distance = (targetPos - currentPos).Magnitude
    
    -- Hitung durasi berdasarkan kecepatan (Jarak / Speed)
    local timeToTravel = distance / Config.Speed
    
    local TweenInfoData = TweenInfo.new(
        timeToTravel, 
        Enum.EasingStyle.Linear, -- Linear agar gerakan mulus seperti terbang
        Enum.EasingDirection.Out
    )
    
    -- Matikan gravitasi sementara agar tidak jatuh saat tween
    local oldState = hrp.Anchored
    hrp.Anchored = true 
    
    local tween = Services.TweenService:Create(hrp, TweenInfoData, {CFrame = targetCFrame})
    tween:Play()
    
    -- Tunggu sampai sampai
    tween.Completed:Wait()
    
    -- Kembalikan state anchor
    hrp.Anchored = oldState
end

-- Fungsi Cek Crystal
local function isActiveCrystal(crystal)
    for _, v in ipairs(crystal:GetDescendants()) do
        if v:IsA("PointLight") or v:IsA("Highlight") or v:IsA("ProximityPrompt") then
            return true
        end
    end
    return false
end

-- [LOGIKA UTAMA]
task.spawn(function()
    local Islands = Services.Workspace:FindFirstChild("Islands")
    local CryFolder = Islands and Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
    
    -- Remotes (Sesuai snippet user)
    local EquipRemote = Services.ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RE/EquipToolFromHotbar"]
    
    local ReturnCFrame = nil

    while true do
        if States.AutoCrystal and CryFolder then
            local hrp = GetRoot()
            
            if hrp then
                -- Cari Crystal Aktif
                local activeCrystals = {}
                for _, crystal in ipairs(CryFolder:GetChildren()) do
                    if isActiveCrystal(crystal) then
                        table.insert(activeCrystals, crystal)
                    end
                end

                if #activeCrystals > 0 then
                    -- 1. Simpan Posisi Awal
                    if not ReturnCFrame then
                        ReturnCFrame = hrp.CFrame
                    end

                    -- 2. Equip Pickaxe (Slot 2)
                    pcall(function() EquipRemote:FireServer(2) end)
                    task.wait(0.5)

                    -- 3. Loop Mining
                    for _, crystal in ipairs(activeCrystals) do
                        if not States.AutoCrystal then break end -- Stop jika dimatikan di tengah jalan
                        
                        -- Dapatkan Posisi Target
                        local targetCF = nil
                        if crystal:IsA("Model") then
                            targetCF = crystal:GetPivot()
                        elseif crystal:IsA("BasePart") then
                            targetCF = crystal.CFrame
                        end

                        if targetCF then
                            -- [MODIFIED] Menggunakan SafeFlyTo alih-alih set CFrame langsung
                            -- Terbang ke posisi crystal (sedikit di atas/samping agar tidak nyangkut)
                            local flyPos = targetCF * CFrame.new(0, 0, 2) 
                            SafeFlyTo(flyPos)
                            
                            task.wait(0.2) -- Stabilisasi

                            -- Interact Prompt
                            local promptFound = false
                            for _, v in ipairs(crystal:GetDescendants()) do
                                if v:IsA("ProximityPrompt") and v.Enabled then
                                    fireproximityprompt(v, v.HoldDuration or 1) -- Support HoldDuration
                                    promptFound = true
                                end
                            end
                            
                            if promptFound then
                                -- [REQUESTED] Delay 7 Detik setelah extract
                                task.wait(Config.DelayPerCrystal)
                            end
                        end
                    end
                    
                    -- 4. Balik ke Posisi Awal (Safe Fly)
                    if States.AutoCrystal and ReturnCFrame then
                        SafeFlyTo(ReturnCFrame)
                        ReturnCFrame = nil -- Reset posisi simpan
                    end

                    -- 5. Equip Rod Kembali (Slot 1)
                    task.wait(0.5)
                    pcall(function() EquipRemote:FireServer(1) end)
                end
            end
        else
            -- Reset jika fitur mati
            ReturnCFrame = nil
        end
        task.wait(1)
    end
end)
