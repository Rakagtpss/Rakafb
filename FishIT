-- [[ MINI MINING HUB V5.9 - FRONT POSITION & LOGIC FIX ]]
-- Update: Fixed Position (Face Target), User Remote Path, Unified Logic

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Workspace = game:GetService("Workspace"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService")
}

local Player = Services.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- // 1. UI SETUP (CLEAN & MINIMALIST)
if Services.CoreGui:FindFirstChild("MiniMiningUI") then Services.CoreGui.MiniMiningUI:Destroy() end
if PlayerGui:FindFirstChild("MiniMiningUI") then PlayerGui.MiniMiningUI:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiniMiningUI"
pcall(function() ScreenGui.Parent = Services.CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = PlayerGui end

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 250, 0, 170)
MainFrame.Position = UDim2.new(0.5, -125, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.BorderSizePixel = 0
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

-- Header
local Title = Instance.new("TextLabel", MainFrame)
Title.Text = "MINING HUB V5.9 (FIXED)"
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 13

local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Text = "Status: Idle"
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.Position = UDim2.new(0, 0, 1, -25)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 11

local function Notify(msg, color)
    StatusLabel.Text = msg
    StatusLabel.TextColor3 = color or Color3.new(1,1,1)
end

-- Drag Function
local dragging, dragInput, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true; dragStart = input.Position; startPos = MainFrame.Position
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
MainFrame.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)

-- // 2. CONFIG REMOTE (SESUAI REQUEST USER)
local RemoteEquip = nil
local SuccessRemote, Err = pcall(function()
    -- Path spesifik dari User
    RemoteEquip = Services.ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RE/EquipToolFromHotbar"]
end)

if not RemoteEquip then
    Notify("REMOTE NOT FOUND!", Color3.fromRGB(255, 0, 0))
    warn("Remote Error: " .. tostring(Err))
else
    Notify("Remote Connected.", Color3.fromRGB(0, 255, 0))
end

-- // 3. MOVEMENT & POSITION HELPERS
local function GetRoot() 
    return Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") 
end

local function GetHum() 
    return Player.Character and Player.Character:FindFirstChild("Humanoid") 
end

local function SafeStop()
    local hrp = GetRoot()
    local hum = GetHum()
    if not hrp or not hum then return end
    
    if hrp:FindFirstChild("MiningBodyVel") then hrp.MiningBodyVel:Destroy() end
    
    hrp.AssemblyLinearVelocity = Vector3.zero
    hrp.AssemblyAngularVelocity = Vector3.zero
    hum.PlatformStand = false
end

local function SafeTween(targetCF)
    local hrp = GetRoot()
    if not hrp then return end
    
    -- Hitung jarak dan waktu
    local dist = (hrp.Position - targetCF.Position).Magnitude
    local speed = 55 -- Speed standar agar tidak kick
    local time = math.max(0.1, dist / speed)
    
    local ti = TweenInfo.new(time, Enum.EasingStyle.Linear)
    local tw = Services.TweenService:Create(hrp, ti, {CFrame = targetCF})
    tw:Play()
    tw.Completed:Wait()
    
    hrp.AssemblyLinearVelocity = Vector3.zero -- Stop momentum setelah sampai
end

-- // 4. LOGIKA MINING (CORE)
local States = { AutoCrystal = false, AutoLava = false, IsBusy = false }

local function StartMiningJob(folderName, toggleVarName)
    -- Cek apakah folder ada dan punya child
    local Islands = Services.Workspace:FindFirstChild("Islands")
    if not Islands then return end
    
    -- Logic pencarian folder yang dinamis (Lava Basin atau Crystal Depths)
    local TargetFolder = nil
    if Islands:FindFirstChild(folderName) then
        TargetFolder = Islands[folderName]:FindFirstChild("Crystals")
    end
    
    if not TargetFolder then return end

    -- Cek Prompt Aktif
    local activeNodes = {}
    for _, v in ipairs(TargetFolder:GetChildren()) do
        if v:FindFirstChild("ProximityPrompt", true) and v:FindFirstChild("ProximityPrompt", true).Enabled then
            table.insert(activeNodes, v)
        end
    end
    
    if #activeNodes == 0 then return end -- Tidak ada crystal spawn

    -- == MULAI SEQUENCE ==
    States.IsBusy = true
    Notify("Event Detected: " .. folderName, Color3.fromRGB(0, 255, 255))
    
    local hrp = GetRoot()
    local hum = GetHum()
    local savedPos = hrp.CFrame -- Simpan Posisi Awal
    
    task.wait(0.5)

    -- [STEP A] EQUIP PICKAXE (SLOT 2)
    Notify("Equipping Pickaxe...", Color3.fromRGB(255, 200, 0))
    if RemoteEquip then pcall(function() RemoteEquip:FireServer(2) end) end
    task.wait(0.8)

    -- [STEP B] ENABLE FLY
    if hum then hum.PlatformStand = true end
    if hrp and not hrp:FindFirstChild("MiningBodyVel") then
        local bv = Instance.new("BodyVelocity", hrp)
        bv.Name = "MiningBodyVel"
        bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bv.Velocity = Vector3.zero
    end

    -- [STEP C] LOOP MINING
    for i, node in ipairs(activeNodes) do
        if not States[toggleVarName] then break end -- Break jika dimatikan manual
        hrp = GetRoot()
        if not hrp then break end

        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            -- [[ LOGIC POSISI BARU: DI DEPAN ]]
            local nodePivot = node:IsA("Model") and node:GetPivot() or node.CFrame
            
            -- Posisi target: 3.5 stud "Mundur" dari titik tengah crystal (relatif axis Z)
            -- Kita pakai LookAt agar karakter menghadap Crystal
            local targetPos = nodePivot * CFrame.new(0, 0, 3.5) 
            local finalCFrame = CFrame.lookAt(targetPos.Position, nodePivot.Position)
            
            Notify("Mining Node " .. i .. "/" .. #activeNodes, Color3.fromRGB(100, 255, 100))
            SafeTween(finalCFrame)
            
            -- Fire Prompt
            task.wait(0.2)
            fireproximityprompt(prompt)
            
            -- Smart Wait (Tunggu sampai prompt hilang/selesai)
            local maxWait = 7
            local t = 0
            while t < maxWait and prompt.Enabled do
                task.wait(0.5)
                t = t + 0.5
            end
        end
    end

    -- [STEP D] FINISH & RETURN
    SafeStop()
    if savedPos and hrp then
        Notify("Returning...", Color3.fromRGB(0, 150, 255))
        SafeTween(savedPos)
    end
    
    -- [STEP E] EQUIP ROD (SLOT 1)
    Notify("Equipping Rod...", Color3.fromRGB(0, 255, 100))
    if RemoteEquip then pcall(function() RemoteEquip:FireServer(1) end) end
    
    task.wait(1)
    States.IsBusy = false
    Notify("Waiting for spawn...", Color3.fromRGB(150, 150, 150))
end

-- // 5. UI BUTTONS
local function CreateToggle(text, yPos, varState, folderTarget)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Size = UDim2.new(0.9, 0, 0, 35)
    btn.Position = UDim2.new(0.05, 0, 0, yPos)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    btn.Text = text .. " [OFF]"
    btn.TextColor3 = Color3.fromRGB(180, 180, 180)
    btn.Font = Enum.Font.GothamSemibold
    btn.TextSize = 12
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

    btn.MouseButton1Click:Connect(function()
        States[varState] = not States[varState]
        
        if States[varState] then
            btn.Text = text .. " [ON]"
            btn.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
            btn.TextColor3 = Color3.new(1,1,1)
            Notify(text .. " Activated", Color3.fromRGB(0, 255, 0))
        else
            btn.Text = text .. " [OFF]"
            btn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
            btn.TextColor3 = Color3.fromRGB(180, 180, 180)
            States.IsBusy = false -- Force Stop Flag
            SafeStop()
            Notify("Stopped.", Color3.fromRGB(255, 100, 100))
        end
    end)
end

CreateToggle("Auto Crystal Depths", 40, "AutoCrystal", "Crystal Depths")
CreateToggle("Auto Lava Basin", 80, "AutoLava", "Lava Basin")

-- // 6. MAIN LOOPS (MONITORING)
-- Loop Crystal Depths
task.spawn(function()
    while true do
        task.wait(1)
        if States.AutoCrystal and not States.IsBusy then
            pcall(function()
                StartMiningJob("Crystal Depths", "AutoCrystal")
            end)
        end
    end
end)

-- Loop Lava Basin
task.spawn(function()
    while true do
        task.wait(1)
        if States.AutoLava and not States.IsBusy then
            pcall(function()
                StartMiningJob("Lava Basin", "AutoLava")
            end)
        end
    end
end)
