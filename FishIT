-- [[ MINI MINING HUB V4.1 - FIX SWAP ]]
-- Fitur: Force Swap (Manual Parent + Remote), Safe Teleport, Auto Mining.

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Workspace = game:GetService("Workspace"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService")
}

local Player = Services.Players.LocalPlayer

-- // 1. REMOTE & CONFIG
-- Pastikan path remote ini benar sesuai game (biasanya Fisch / game sejenis)
local RemoteEquip = Services.ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")
    :WaitForChild("RE/EquipToolFromHotbar")

local States = {
    AutoCrystal = false,
    AutoLava = false,
    IsMining = false
}

-- Fungsi Dasar Character
local function GetChar() return Player.Character or Player.CharacterAdded:Wait() end
local function GetRoot() local c = Player.Character; return c and c:FindFirstChild("HumanoidRootPart") end
local function GetHum() local c = Player.Character; return c and c:FindFirstChild("Humanoid") end

-- // 2. FUNGSI SWAP ALAT (PERBAIKAN UTAMA DI SINI)
local function ForceSwapToPickaxe()
    local char = GetChar()
    local hum = GetHum()
    if not char or not hum then return end

    -- [STEP 1] FORCE LEPAS SLOT 1 (ROD)
    -- Kita cek apakah ada tool yang sedang dipegang
    local currentTool = char:FindFirstChildWhichIsA("Tool")
    
    if currentTool then
        -- 1. Paksa pindah ke Backpack (Client Side Force)
        currentTool.Parent = Player.Backpack
    end

    -- 2. Matikan via Humanoid (Standar Roblox)
    hum:UnequipTools()
    
    -- 3. Beri tahu Server kita unequip Slot 1 (Agar tidak bug di server)
    pcall(function() 
        RemoteEquip:FireServer(1) 
    end)
    
    task.wait(0.4) -- Waktu tunggu sedikit diperlama agar server memproses unequip

    -- [STEP 2] EQUIP SLOT 2 (PICKAXE)
    -- Prioritas 1: Gunakan Remote (Cara Resmi Game)
    pcall(function()
        RemoteEquip:FireServer(2) 
    end)
    
    task.wait(0.2)

    -- Prioritas 2: Fallback Manual (Jika Remote gagal)
    local toolCheck = char:FindFirstChildWhichIsA("Tool")
    if not toolCheck then
        -- Cari Pickaxe di backpack kalau belum terpasang
        local backpack = Player.Backpack
        for _, tool in pairs(backpack:GetChildren()) do
            if tool:IsA("Tool") and string.find(string.lower(tool.Name), "pick") then
                tool.Parent = char -- Paksa pasang
                break
            end
        end
    end
end

local function ReturnToRod()
    local char = GetChar()
    local hum = GetHum()
    
    -- Lepas Pickaxe
    if char then
        local currentTool = char:FindFirstChildWhichIsA("Tool")
        if currentTool then currentTool.Parent = Player.Backpack end
    end
    if hum then hum:UnequipTools() end
    
    task.wait(0.3)
    
    -- Paksa Server Equip Slot 1
    pcall(function() RemoteEquip:FireServer(1) end) 
end

-- // 3. UI SETUP
if Services.CoreGui:FindFirstChild("MiniMiningUI") then Services.CoreGui.MiniMiningUI:Destroy() end
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiniMiningUI"
ScreenGui.Parent = Services.CoreGui

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 220, 0, 130)
MainFrame.Position = UDim2.new(0.5, -110, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
MainFrame.BorderSizePixel = 0
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.Text = "MINING HUB V4.1 (FIXED)"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 12

-- Drag Logic
local dragging, dragInput, dragStart, startPos
local function UpdateDrag(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true; dragStart = input.Position; startPos = MainFrame.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        if dragging then UpdateDrag(input) end
    end
end)

local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Size = UDim2.new(1, 0, 0, 15)
StatusLabel.Position = UDim2.new(0, 0, 1, -15)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Ready..."
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 10

local function Notify(msg, color)
    StatusLabel.Text = msg
    StatusLabel.TextColor3 = color or Color3.fromRGB(200, 200, 200)
end

-- // 4. SISTEM BYPASS (FLY & NOCLIP & SAFE TP)
local NoclipConn = nil

local function SetBypass(bool)
    local hrp = GetRoot()
    local hum = GetHum()
    if not hrp or not hum then return end

    if bool then
        -- 1. Fly (Velocity 0)
        if not hrp:FindFirstChild("MiningFly") then
            local bv = Instance.new("BodyVelocity")
            bv.Name = "MiningFly"
            bv.Parent = hrp
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bv.Velocity = Vector3.zero 
        end
        hum.PlatformStand = true 
        
        -- 2. Noclip
        if not NoclipConn then
            NoclipConn = Services.RunService.Stepped:Connect(function()
                if Player.Character then
                    for _, v in pairs(Player.Character:GetDescendants()) do
                        if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
                    end
                end
            end)
        end
    else
        -- Matikan Semua
        if hrp:FindFirstChild("MiningFly") then hrp.MiningFly:Destroy() end
        hum.PlatformStand = false
        if NoclipConn then NoclipConn:Disconnect(); NoclipConn = nil end
    end
end

local function SafeTeleport(targetCFrame)
    local hrp = GetRoot()
    if not hrp then return end
    hrp.AssemblyLinearVelocity = Vector3.zero
    hrp.AssemblyAngularVelocity = Vector3.zero
    hrp.CFrame = targetCFrame
    task.wait(0.05)
    hrp.AssemblyLinearVelocity = Vector3.zero
end

-- // 5. LOGIKA MINING CERDAS
local function GetActiveNodes(folder)
    local activeList = {}
    if not folder then return activeList end
    for _, item in ipairs(folder:GetChildren()) do
        if item:IsA("Model") or item:IsA("BasePart") then
            local prompt = item:FindFirstChildWhichIsA("ProximityPrompt", true)
            if prompt and prompt.Enabled then table.insert(activeList, item) end
        end
    end
    return activeList
end

local function SmartMining(folder, toggleState)
    local activeNodes = GetActiveNodes(folder)
    if #activeNodes == 0 then return false end
    
    local hrp = GetRoot()
    if not hrp then return false end

    States.IsMining = true 
    local SafeReturnPos = hrp.CFrame
    Notify("Found " .. #activeNodes .. " Nodes", Color3.fromRGB(0, 255, 255))
    
    -- [AUTO SWAP]
    ForceSwapToPickaxe()
    
    -- Cek ulang apakah Pickaxe sudah di tangan
    local char = GetChar()
    if not char:FindFirstChildWhichIsA("Tool") then
        Notify("Failed to equip Pickaxe!", Color3.fromRGB(255, 50, 50))
        -- Coba sekali lagi
        ForceSwapToPickaxe()
    end
    
    task.wait(0.5)
    SetBypass(true)

    for i, node in ipairs(activeNodes) do
        if not States[toggleState] then break end
        
        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            local targetCF = node:IsA("Model") and node:GetPivot() or node.CFrame
            
            if targetCF then
                local dest = targetCF + Vector3.new(0, 4, 0)
                SafeTeleport(dest)
                Notify("Mining " .. i .. "/" .. #activeNodes, Color3.fromRGB(255, 200, 50))
                
                task.wait(0.5) 
                
                fireproximityprompt(prompt)
                task.wait(3.8) 
            end
        end
    end

    Notify("Done! Returning...", Color3.fromRGB(100, 255, 100))
    SetBypass(false)
    SafeTeleport(SafeReturnPos)
    task.wait(1)
    
    ReturnToRod()
    
    States.IsMining = false
    return true
end

-- // 6. TOMBOL UI
local function CreateSwitch(text, stateKey, posY)
    local Btn = Instance.new("TextButton", MainFrame)
    Btn.Size = UDim2.new(0.9, 0, 0, 30)
    Btn.Position = UDim2.new(0.05, 0, 0, posY)
    Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    Btn.Text = text .. ": OFF"
    Btn.TextColor3 = Color3.fromRGB(200, 200, 200)
    Btn.Font = Enum.Font.GothamBold
    Btn.TextSize = 11
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)
    
    Btn.MouseButton1Click:Connect(function()
        States[stateKey] = not States[stateKey]
        
        if not States[stateKey] then
             SetBypass(false) 
             States.IsMining = false
        end

        if States[stateKey] then
            Btn.Text = text .. ": ON"
            Btn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
            Btn.TextColor3 = Color3.new(1,1,1)
        else
            Btn.Text = text .. ": OFF"
            Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            Btn.TextColor3 = Color3.fromRGB(200, 200, 200)
        end
    end)
end

CreateSwitch("Auto Crystal", "AutoCrystal", 40)
CreateSwitch("Auto Lava", "AutoLava", 75)

-- // 7. LOOPS
task.spawn(function()
    while true do
        if States.AutoCrystal then
             -- Pastikan path folder benar sesuai update game terbaru
             local Islands = Services.Workspace:FindFirstChild("Islands")
             local CryFolder = Islands and Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
             
             if CryFolder then
                local success = SmartMining(CryFolder, "AutoCrystal")
                if success then task.wait(5) else task.wait(2) end
             else
                Notify("Crystals not found!", Color3.fromRGB(255, 50, 50))
                task.wait(2)
             end
        else
            task.wait(2)
        end
    end
end)

task.spawn(function()
    while true do
        if States.AutoLava then
            pcall(function()
                local Islands = Services.Workspace:FindFirstChild("Islands")
                local LavaFolder = Islands and Islands:FindFirstChild("Lava Basin") and Islands["Lava Basin"]:FindFirstChild("Crystals")
                if LavaFolder then
                    local success = SmartMining(LavaFolder, "AutoLava")
                    if success then task.wait(5) else task.wait(2) end
                end
            end)
        else
            task.wait(2)
        end
    end
end)
