local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- --- 1. SETUP REMOTE FUNCTIONS ---
local Packages = ReplicatedStorage:WaitForChild("Packages")
local Index = Packages:WaitForChild("_Index")
local Sleitnick = Index:WaitForChild("sleitnick_net@0.2.0")
local NetFolder = Sleitnick:WaitForChild("net")

local Remotes = {
    ChargeRod = NetFolder:WaitForChild("RF/ChargeFishingRod"),
    CatchCompleted = NetFolder:WaitForChild("RF/CatchFishCompleted"),
    CancelInputs = NetFolder:WaitForChild("RF/CancelFishingInputs"),
    RequestMinigame = NetFolder:WaitForChild("RF/RequestFishingMinigameStarted"),
    UpdateState = NetFolder:WaitForChild("RF/UpdateAutoFishingState"),
}

-- --- 2. CONFIG VARIABLE ---
local Config = {
    IsActive = false,
    MinShakeDelay = 0.5, 
    MaxShakeDelay = 1.0, 
    CastPower = 100,      
}

-- --- 3. UI GENERATION (Skipped for brevity - Same as before) ---
-- (Gunakan UI yang sama seperti sebelumnya, bagian ini hanya logika inti perbaikan)

if getgenv and getgenv().FishUI then getgenv().FishUI:Destroy() end
if CoreGui:FindFirstChild("FishingConfigUI") then CoreGui.FishingConfigUI:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FishingConfigUI"
if pcall(function() ScreenGui.Parent = CoreGui end) then else ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 260, 0, 160)
MainFrame.Position = UDim2.new(0.5, -130, 0.5, -80)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.Parent = ScreenGui
local UICorner = Instance.new("UICorner"); UICorner.CornerRadius = UDim.new(0, 10); UICorner.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Text = "üé£ Auto Fish Fix v2"
Title.Size = UDim2.new(1,0,0,30); Title.TextColor3 = Color3.new(1,1,1); Title.BackgroundTransparency = 1; Title.Parent = MainFrame

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Text = "Status: Idle"; StatusLabel.Size = UDim2.new(1,0,0,20); StatusLabel.Position = UDim2.new(0,0,0,30); StatusLabel.TextColor3 = Color3.fromRGB(150,150,150); StatusLabel.BackgroundTransparency = 1; StatusLabel.Parent = MainFrame

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Text = "START"; ToggleBtn.Size = UDim2.new(0,220,0,45); ToggleBtn.Position = UDim2.new(0,20,0,100); ToggleBtn.BackgroundColor3 = Color3.fromRGB(200,60,60); ToggleBtn.TextColor3 = Color3.new(1,1,1); ToggleBtn.Parent = MainFrame
local BtnCorner = Instance.new("UICorner"); BtnCorner.Parent = ToggleBtn

-- --- 4. LOGIKA PERBAIKAN ---

local function GetRod()
    local Char = LocalPlayer.Character
    if not Char then return nil end
    -- Cari tool yang sedang dipegang
    local Tool = Char:FindFirstChildWhichIsA("Tool")
    if Tool and (Tool.Name:find("Rod") or Tool:FindFirstChild("Bobber")) then
        return Tool
    end
    return nil
end

local function FishingRoutine()
    task.spawn(function()
        while Config.IsActive do
            local Rod = GetRod()
            if not Rod then
                StatusLabel.Text = "‚ö†Ô∏è Pegang pancingan dulu!"
                task.wait(1)
                continue
            end

            -- A. CHARGE ROD
            StatusLabel.Text = "1. Casting..."
            -- Error "Assertion Failed" sering terjadi karena Power = 0 atau nil.
            -- Kita kirim Power 100 dan Posisi asal (karena server mungkin validasi jarak)
            local Power = Config.CastPower
            local BobberPos = LocalPlayer.Character.HumanoidRootPart.Position + (LocalPlayer.Character.HumanoidRootPart.CFrame.LookVector * 15) -- Lempar 15 stud ke depan
            
            -- Coba kirim argumen Power saja dulu (sesuai log kamu sebelumnya yg hanya 1 argumen angka)
            -- Tapi jika error lagi, server mungkin butuh Vector3.
            local success, err = pcall(function()
                 Remotes.ChargeRod:InvokeServer(Power, BobberPos) 
            end)
            
            if not success then
                -- Fallback: Coba kirim tanpa argumen atau hanya 1 argumen jika gagal
                 Remotes.ChargeRod:InvokeServer(Power)
            end

            task.wait(1.5) -- Tunggu animasi lempar
            
            -- B. SHAKE DELAY
            local shakeDelay = 2.0 + math.random() * 1.5 -- Tambah delay alami
            StatusLabel.Text = "2. Waiting Fish..."
            task.wait(shakeDelay)
            
            if not Config.IsActive then break end

            -- C. REQUEST MINIGAME
            StatusLabel.Text = "3. Hooking..."
            -- Argumen log kamu: (12.21, 0.5, timestamp). Kita ikuti format itu.
            -- 12.21 itu Power/Distance. 0.5 itu Difficulty.
            local timestamp = workspace:GetServerTimeNow()
            Remotes.RequestMinigame:InvokeServer(Power, 0.5, timestamp)
            
            task.wait(1) -- Simulasi main minigame
            
            -- D. CATCH
            StatusLabel.Text = "4. Catching!"
            Remotes.CatchCompleted:InvokeServer()
            
            StatusLabel.Text = "‚úÖ Got Fish!"
            task.wait(1.5) -- Cooldown
        end
        
        StatusLabel.Text = "Stopped."
        Remotes.UpdateState:InvokeServer(false)
    end)
end

ToggleBtn.MouseButton1Click:Connect(function()
    Config.IsActive = not Config.IsActive
    if Config.IsActive then
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
        ToggleBtn.Text = "STOP"
        FishingRoutine()
    else
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
        ToggleBtn.Text = "START"
    end
end)
