-- [[ MINI MINING HUB V6.1 - TAKE ALL & RETURN ]]
-- Logika: Detect > Save Pos > Mine Sampai Habis > Pulang

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Workspace = game:GetService("Workspace"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService")
}

local Player = Services.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- // UI SETUP
if Services.CoreGui:FindFirstChild("MiniMiningUI") then Services.CoreGui.MiniMiningUI:Destroy() end
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiniMiningUI"
pcall(function() ScreenGui.Parent = Services.CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = PlayerGui end

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 240, 0, 160)
MainFrame.Position = UDim2.new(0.5, -120, 0.2, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Text = "Ready."
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.Position = UDim2.new(0, 0, 1, -20)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)

local function Notify(msg, color)
    StatusLabel.Text = msg
    StatusLabel.TextColor3 = color or Color3.new(1,1,1)
end

-- // CONFIG REMOTE
local RemoteEquip = nil
pcall(function()
    RemoteEquip = Services.ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RE/EquipToolFromHotbar"]
end)

-- // HELPERS
local function GetChar() return Player.Character or Player.CharacterAdded:Wait() end
local function GetHum() local c = Player.Character; return c and c:FindFirstChild("Humanoid") end
local function GetRoot() local c = Player.Character; return c and c:FindFirstChild("HumanoidRootPart") end

local function SafeStop()
    local hrp = GetRoot()
    local hum = GetHum()
    if not hrp or not hum then return end
    if hrp:FindFirstChild("MiningFly") then hrp.MiningFly:Destroy() end
    hrp.AssemblyLinearVelocity = Vector3.zero
    hum.PlatformStand = false
    hrp.Anchored = true; task.wait(0.1); hrp.Anchored = false
end

local function SafeTween(targetCFrame)
    local hrp = GetRoot()
    if not hrp then return end
    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    if dist < 2 then return end
    local ti = TweenInfo.new(math.max(dist/60, 0.1), Enum.EasingStyle.Linear)
    Services.TweenService:Create(hrp, ti, {CFrame = targetCFrame}):Play()
    task.wait(math.max(dist/60, 0.1))
    hrp.AssemblyLinearVelocity = Vector3.zero
end

-- // LOGIKA UTAMA
local States = { AutoCrystal = false, AutoLava = false, IsMining = false }

local function RunMiningSequence(folder, toggleKey)
    local activeNodes = {}
    for _, v in ipairs(folder:GetChildren()) do
        if v:FindFirstChild("ProximityPrompt", true) then table.insert(activeNodes, v) end
    end
    if #activeNodes == 0 then return end 

    States.IsMining = true
    local hrp = GetRoot()
    local hum = GetHum()
    
    Notify("SPAWN DETECTED!", Color3.fromRGB(0, 255, 255))
    task.wait(1)

    -- [1] SAVE POSITION
    local SavedPosition = hrp.CFrame
    Notify("Saving Pos...", Color3.fromRGB(255, 255, 0))
    task.wait(0.2)

    -- [2] EQUIP PICKAXE
    Notify("Equip Pickaxe...", Color3.fromRGB(0, 255, 0))
    pcall(function() RemoteEquip:FireServer(2) end)
    task.wait(0.6)

    -- [3] MINE ALL LOOP
    if hum then 
        hum.PlatformStand = true 
        if not hrp:FindFirstChild("MiningFly") then
            local bv = Instance.new("BodyVelocity")
            bv.Name = "MiningFly"; bv.Parent = hrp
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge); bv.Velocity = Vector3.zero
        end
    end

    for i, node in ipairs(activeNodes) do
        if not States[toggleKey] then break end
        
        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            -- Posisi Depan Crystal
            local nodeCF = node:IsA("Model") and node:GetPivot() or node.CFrame
            local targetPos = nodeCF * CFrame.new(0, 0, 4) 
            local finalCF = CFrame.lookAt(targetPos.Position, nodeCF.Position)
            
            SafeTween(finalCF)
            Notify("Mining " .. i .. "/" .. #activeNodes, Color3.fromRGB(255, 170, 0))
            task.wait(0.3)
            fireproximityprompt(prompt)
            
            for k = 7, 1, -1 do
                if not States[toggleKey] then break end
                Notify("Wait " .. k .. "s", Color3.fromRGB(100, 255, 100))
                task.wait(1)
            end
        end
    end

    -- [4] RETURN
    Notify("Returning...", Color3.fromRGB(0, 255, 255))
    SafeTween(SavedPosition)
    SafeStop()

    -- [5] EQUIP ROD
    Notify("Equip Rod...", Color3.fromRGB(0, 255, 120))
    pcall(function() RemoteEquip:FireServer(1) end)
    
    States.IsMining = false
    Notify("Idle.", Color3.fromRGB(150, 150, 150))
end

-- // UI BUTTONS
local function CreateBtn(txt, yPos, varName)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Size = UDim2.new(0.9, 0, 0, 30); btn.Position = UDim2.new(0.05, 0, 0, yPos)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50); btn.Text = txt .. ": OFF"
    btn.TextColor3 = Color3.fromRGB(200, 200, 200); Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    
    btn.MouseButton1Click:Connect(function()
        States[varName] = not States[varName]
        if States[varName] then
            btn.Text = txt .. ": ON"; btn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
        else
            btn.Text = txt .. ": OFF"; btn.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
            States.IsMining = false; SafeStop()
        end
    end)
end
CreateBtn("Auto Crystal", 35, "AutoCrystal")
CreateBtn("Auto Lava", 70, "AutoLava")

-- // LOOPS
task.spawn(function()
    while true do
        task.wait(1)
        if States.AutoCrystal and not States.IsMining then
            pcall(function()
                local F = Services.Workspace.Islands["Crystal Depths"]:FindFirstChild("Crystals")
                if F then
                    local r = false
                    for _,v in ipairs(F:GetChildren()) do if v:FindFirstChild("ProximityPrompt", true).Enabled then r=true break end end
                    if r then RunMiningSequence(F, "AutoCrystal") end
                end
            end)
        end
    end
end)
-- (Tambahkan loop Lava Basin di sini jika perlu, sama strukturnya)
