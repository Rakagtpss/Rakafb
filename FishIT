-- ==========================================
-- SMART AUTO-EQUIP UI (Targeted Inventory Scan)
-- ==========================================

local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- Path ke RemoteEvent Equip
local Event = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")
    :WaitForChild("RE/EquipItem")

-- Mencegah duplikasi UI
if CoreGui:FindFirstChild("SmartEquipUI") then
    CoreGui.SmartEquipUI:Destroy()
end

-- Membuat ScreenGui Utama
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SmartEquipUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = (pcall(function() return CoreGui.Name end) and CoreGui) or Players.LocalPlayer:WaitForChild("PlayerGui")

-- Membuat Frame (Background)
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 240, 0, 140)
MainFrame.Position = UDim2.new(0.5, -120, 0.5, -70)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local UICornerMain = Instance.new("UICorner")
UICornerMain.CornerRadius = UDim.new(0, 8)
UICornerMain.Parent = MainFrame

-- Title Label
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Text = " üéØ Smart Auto-Equip"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = MainFrame

local UICornerTitle = Instance.new("UICorner")
UICornerTitle.CornerRadius = UDim.new(0, 8)
UICornerTitle.Parent = Title

local TitleBlocker = Instance.new("Frame")
TitleBlocker.Size = UDim2.new(1, 0, 0, 10)
TitleBlocker.Position = UDim2.new(0, 0, 1, -10)
TitleBlocker.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
TitleBlocker.BorderSizePixel = 0
TitleBlocker.Parent = Title

-- Input: Nama Item
local ItemNameInput = Instance.new("TextBox")
ItemNameInput.Size = UDim2.new(0, 200, 0, 30)
ItemNameInput.Position = UDim2.new(0.5, -100, 0, 45)
ItemNameInput.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
ItemNameInput.TextColor3 = Color3.fromRGB(255, 255, 255)
ItemNameInput.Font = Enum.Font.Gotham
ItemNameInput.TextSize = 13
ItemNameInput.Text = "Gears"
ItemNameInput.PlaceholderText = "Ketik Nama Item..."
ItemNameInput.ClearTextOnFocus = false
ItemNameInput.Parent = MainFrame

local UICornerItem = Instance.new("UICorner")
UICornerItem.CornerRadius = UDim.new(0, 4)
UICornerItem.Parent = ItemNameInput

-- Tombol Equip
local EquipBtn = Instance.new("TextButton")
EquipBtn.Size = UDim2.new(0, 200, 0, 40)
EquipBtn.Position = UDim2.new(0.5, -100, 0, 85)
EquipBtn.BackgroundColor3 = Color3.fromRGB(255, 140, 0) -- Warna Orange
EquipBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
EquipBtn.Text = "Cari & Equip!"
EquipBtn.Font = Enum.Font.GothamBold
EquipBtn.TextSize = 14
EquipBtn.AutoButtonColor = true
EquipBtn.Parent = MainFrame

local UICornerBtn = Instance.new("UICorner")
UICornerBtn.CornerRadius = UDim.new(0, 6)
UICornerBtn.Parent = EquipBtn

-- ==========================================
-- FUNGSI PENCARIAN UUID (Anti-Crash)
-- ==========================================
local function FindItemUUID(targetName)
    local InvController
    pcall(function()
        InvController = require(ReplicatedStorage.Controllers.InventoryController)
    end)
    
    if not InvController then return nil end

    local foundUUID = nil
    local visited = {}
    -- Regex untuk format UUID (contoh: 749cf3d4-2548-4ad6-80ae-98af016726f9)
    local uuidPattern = "^%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x$"

    local function scanTable(t, depth)
        if depth > 4 or visited[t] then return end
        visited[t] = true
        
        for k, v in pairs(t) do
            -- Cek jika kuncinya adalah UUID (Sering terjadi di database inventory)
            if type(k) == "string" and string.match(k, uuidPattern) and type(v) == "table" then
                for _, val in pairs(v) do
                    if type(val) == "string" and val == targetName then
                        foundUUID = k
                        return
                    end
                end
            end
            
            -- Cek jika UUID dan Nama berada dalam tabel yang sama
            if type(v) == "table" then
                local hasName = false
                local tempUUID = nil
                for _, val in pairs(v) do
                    if type(val) == "string" then
                        if val == targetName then hasName = true end
                        if string.match(val, uuidPattern) then tempUUID = val end
                    end
                end
                if hasName and tempUUID then
                    foundUUID = tempUUID
                    return
                end
                scanTable(v, depth + 1)
            end
            
            if foundUUID then return end
        end
    end

    -- 1. Scan tabel utama di InventoryController
    scanTable(InvController, 1)
    
    -- 2. Scan data yang disembunyikan dalam fungsi (Upvalues)
    if not foundUUID then
        for _, func in pairs(InvController) do
            if type(func) == "function" then
                pcall(function()
                    local upvalues = debug.getupvalues(func)
                    for _, upval in pairs(upvalues) do
                        if type(upval) == "table" then
                            scanTable(upval, 1)
                            if foundUUID then return end
                        end
                    end
                end)
            end
        end
    end

    return foundUUID
end

-- ==========================================
-- FUNGSI TOMBOL KLIK
-- ==========================================
EquipBtn.MouseButton1Click:Connect(function()
    local itemName = ItemNameInput.Text
    if itemName == "" then return end

    EquipBtn.Text = "Mencari data..."
    EquipBtn.BackgroundColor3 = Color3.fromRGB(150, 80, 0)
    
    -- Memulai pencarian UUID asli
    local realUUID = FindItemUUID(itemName)
    
    if realUUID then
        print("‚úÖ Ditemukan: " .. itemName .. " | UUID: " .. realUUID)
        EquipBtn.Text = "Mengirim ke server..."
        
        -- Menembak server menggunakan data asli!
        local args = {realUUID, itemName}
        Event:FireServer(unpack(args))
        
        task.wait(0.3)
        EquipBtn.Text = "Berhasil Equip!"
        EquipBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69) -- Hijau
    else
        print("‚ùå Gagal menemukan UUID untuk: " .. itemName)
        EquipBtn.Text = "Item tidak ditemukan!"
        EquipBtn.BackgroundColor3 = Color3.fromRGB(220, 53, 69) -- Merah
    end
    
    -- Kembalikan tombol seperti semula
    task.wait(1.5)
    EquipBtn.Text = "Cari & Equip!"
    EquipBtn.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
end)
