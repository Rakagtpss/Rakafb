--[[
    UPDATED FISHING SCRIPT - WINDUI VERSION
    Fitur: Custom Delay, Auto Great, Instant/Blatant Mode, Anti-AFK
    Updated Paths: sleitnick_net@0.2.0
]]

-- 1. LOAD LIBRARY & SERVICES
local WindUI = loadstring(game:HttpGet("https://tree-hub.vercel.app/api/UI/WindUI"))()
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")

-- 2. DEFINISI REMOTE (UPDATED PATHS)
-- Menggunakan WaitForChild untuk mencegah error jika game belum loading sempurna
local NetPath = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index"):WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net")

local Remotes = {
    Charge      = NetPath:WaitForChild("RF/ChargeFishingRod"),
    Catch       = NetPath:WaitForChild("RF/CatchFishCompleted"),
    Cancel      = NetPath:WaitForChild("RF/CancelFishingInputs"),
    Request     = NetPath:WaitForChild("RF/RequestFishingMinigameStarted"),
    AutoState   = NetPath:WaitForChild("RF/UpdateAutoFishingState"),
    Radar       = NetPath:WaitForChild("RF/UpdateFishingRadar")
}

-- 3. VARIABLE SETTINGS
getgenv().fishingStart = false
getgenv().autoGreat = false

-- Default Config (Bisa diubah lewat UI)
local Config = {
    Mode = "Instant", -- "Instant" atau "Blatan"
    Delays = {
        Charge = 1.15, -- Waktu menunggu sebelum melempar kail lagi
        Catch = 0.56,  -- Waktu menunggu ikan (di mode Instant)
        Reset = 0.20   -- Waktu jeda setelah menangkap
    },
    Coordinates = { -1.115, 0, 1763.636 } -- Koordinat lemparan (Vector/Args)
}

-- 4. ANTI-STUN / BLOCKER SYSTEM
-- Mencegah karakter diam/stuck saat spam remote
local BlockedRemotes = {
    [Remotes.Charge] = true,
    [Remotes.Request] = true,
    [Remotes.Catch] = true,
    [Remotes.Cancel] = true
}

local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    
    -- Jika fishing aktif, kita block remote ini agar client tidak menunggu server (No Animation)
    if getgenv().fishingStart and BlockedRemotes[self] and not checkcaller() then
        if method == "InvokeServer" then
            return task.wait(9e9) -- Freeze thread game asli
        elseif method == "FireServer" then
            return nil
        end
    end
    
    return oldNamecall(self, ...)
end)

-- 5. FUNGSI UTAMA (LOGIC)

local function SetAutoGreat(bool)
    pcall(function()
        Remotes.AutoState:InvokeServer({bool})
    end)
end

-- Mode 1: Instant (Lebih aman, ada delay wajar)
local function LoopInstant()
    if getgenv().autoGreat then SetAutoGreat(true) end
    
    while getgenv().fishingStart do
        -- 1. Charge
        pcall(function() Remotes.Charge:InvokeServer() end)
        task.wait(0.05)
        if not getgenv().fishingStart then break end

        -- 2. Request Game
        pcall(function() Remotes.Request:InvokeServer(unpack(Config.Coordinates)) end)
        
        -- Tunggu ikan (Custom Delay Catch)
        task.wait(Config.Delays.Catch) 
        if not getgenv().fishingStart then break end

        -- 3. Catch
        pcall(function() Remotes.Catch:InvokeServer() end)
        task.wait(0.05)
        
        -- 4. Reset
        pcall(function() Remotes.Cancel:InvokeServer() end)
        
        -- Tunggu sebelum melempar lagi (Custom Delay Charge)
        task.wait(Config.Delays.Charge)
    end
end

-- Mode 2: Blatant (Super Cepat / Spam)
local function LoopBlatant()
    if getgenv().autoGreat then SetAutoGreat(true) end
    
    -- Reset awal biar ga nyangkut
    pcall(function() Remotes.Cancel:InvokeServer() end)
    task.wait(0.1)

    while getgenv().fishingStart do
        -- Gunakan spawn agar tidak saling menunggu (Parallel)
        task.spawn(function()
            pcall(function() Remotes.Charge:InvokeServer() end)
        end)
        
        task.spawn(function()
            pcall(function() Remotes.Request:InvokeServer(unpack(Config.Coordinates)) end)
        end)
        
        task.wait(Config.Delays.Charge) -- Delay Casting
        
        pcall(function() Remotes.Catch:InvokeServer() end)
        
        task.wait(Config.Delays.Reset) -- Delay Reset Cepat
        pcall(function() Remotes.Cancel:InvokeServer() end)
    end
end

-- 6. PEMBUATAN UI (WINDUI)

local Window = WindUI:CreateWindow({
    Title = "Fisching Updated",
    Icon = "fish",
    Author = ".gg/windui",
    Folder = "FischingScript",
    Size = UDim2.fromOffset(580, 460),
    Transparent = true,
    Theme = "Dark",
    SideBarWidth = 170,
    HasOutline = true,
})

local TabMain = Window:Tab({
    Title = "Main Fishing",
    Icon = "anchor"
})

-- SECTION: MODE SELECTION
TabMain:Section({ Title = "Fishing Mode" })

local DropdownMode = TabMain:Dropdown({
    Title = "Select Mode",
    Desc = "Pilih kecepatan fishing",
    Values = {"Instant", "Blatan"},
    Value = "Instant",
    Callback = function(val)
        Config.Mode = val
    end
})

-- SECTION: CUSTOM DELAYS
TabMain:Section({ Title = "Custom Delays (Kecepatan)" })

TabMain:Input({
    Title = "Delay Charge (Detik)",
    Desc = "Jeda sebelum melempar kail",
    Value = tostring(Config.Delays.Charge),
    Placeholder = "Contoh: 1.15",
    Callback = function(text)
        local num = tonumber(text)
        if num then Config.Delays.Charge = num end
    end
})

TabMain:Input({
    Title = "Delay Catch (Detik)",
    Desc = "Jeda menunggu ikan (Mode Instant)",
    Value = tostring(Config.Delays.Catch),
    Placeholder = "Contoh: 0.56",
    Callback = function(text)
        local num = tonumber(text)
        if num then Config.Delays.Catch = num end
    end
})

TabMain:Input({
    Title = "Delay Reset (Detik)",
    Desc = "Jeda setelah ikan ditangkap",
    Value = tostring(Config.Delays.Reset),
    Placeholder = "Contoh: 0.2",
    Callback = function(text)
        local num = tonumber(text)
        if num then Config.Delays.Reset = num end
    end
})

-- SECTION: AUTOMATION
TabMain:Section({ Title = "Automation" })

TabMain:Toggle({
    Title = "Auto Great",
    Desc = "Bar selalu 100% (Perfect Catch)",
    Value = false,
    Callback = function(state)
        getgenv().autoGreat = state
        if state and getgenv().fishingStart then
            SetAutoGreat(true)
        end
    end
})

TabMain:Toggle({
    Title = "Enable Auto Fishing",
    Desc = "Mulai/Stop Script",
    Value = false,
    Callback = function(state)
        getgenv().fishingStart = state
        
        if state then
            WindUI:Notify({Title = "Fishing Started", Content = "Mode: " .. Config.Mode, Duration = 3})
            
            -- Unstuck dulu sebelum mulai
            pcall(function() Remotes.Cancel:InvokeServer() end)
            
            if Config.Mode == "Blatan" then
                task.spawn(LoopBlatant)
            else
                task.spawn(LoopInstant)
            end
        else
            WindUI:Notify({Title = "Fishing Stopped", Content = "Script berhenti...", Duration = 3})
            
            -- Matikan Auto Great
            if getgenv().autoGreat then SetAutoGreat(false) end
            
            -- Cancel fishing inputs
            pcall(function() Remotes.Catch:InvokeServer() end)
            task.wait(0.1)
            pcall(function() Remotes.Cancel:InvokeServer() end)
        end
    end
})

-- SECTION: EXTRAS
TabMain:Section({ Title = "Tools" })

TabMain:Button({
    Title = "Unstuck Character",
    Desc = "Klik jika karakter nge-bug/diam",
    Callback = function()
        pcall(function() Remotes.Cancel:InvokeServer() end)
        pcall(function() Remotes.Catch:InvokeServer() end)
        WindUI:Notify({Title = "Unstuck", Content = "Sinyal Reset Dikirim", Duration = 2})
    end
})

-- 7. ANTI AFK
task.spawn(function()
    Players.LocalPlayer.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end)

WindUI:Notify({
    Title = "Script Loaded",
    Content = "Path Updated & UI Ready!",
    Duration = 5
})
