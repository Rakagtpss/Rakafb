-- ==========================================
-- GEAR CATALOG & AUTO-EQUIP UI
-- ==========================================

local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- Path Penting
local Event = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")
    :WaitForChild("RE/EquipItem")

local GearsFolder = ReplicatedStorage:WaitForChild("Modules")
    :WaitForChild("ModelDownloader")
    :WaitForChild("Collection")
    :WaitForChild("Gears")

-- Mencegah duplikasi UI
if CoreGui:FindFirstChild("GearCatalogUI") then
    CoreGui.GearCatalogUI:Destroy()
end

-- 1. Membuat UI Utama
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "GearCatalogUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = (pcall(function() return CoreGui.Name end) and CoreGui) or Players.LocalPlayer:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 260, 0, 350)
MainFrame.Position = UDim2.new(0.5, -130, 0.5, -175)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local UICornerMain = Instance.new("UICorner")
UICornerMain.CornerRadius = UDim.new(0, 8)
UICornerMain.Parent = MainFrame

-- Title
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 35)
Title.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Text = " âš™ï¸ Gears Catalog"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = MainFrame

local UICornerTitle = Instance.new("UICorner")
UICornerTitle.CornerRadius = UDim.new(0, 8)
UICornerTitle.Parent = Title

local TitleBlocker = Instance.new("Frame")
TitleBlocker.Size = UDim2.new(1, 0, 0, 10)
TitleBlocker.Position = UDim2.new(0, 0, 1, -10)
TitleBlocker.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
TitleBlocker.BorderSizePixel = 0
TitleBlocker.Parent = Title

-- Scrolling Frame (Daftar Gear)
local ItemList = Instance.new("ScrollingFrame")
ItemList.Size = UDim2.new(1, -10, 1, -45)
ItemList.Position = UDim2.new(0, 5, 0, 40)
ItemList.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
ItemList.BorderSizePixel = 0
ItemList.ScrollBarThickness = 6
ItemList.AutomaticCanvasSize = Enum.AutomaticSize.Y
ItemList.CanvasSize = UDim2.new(0, 0, 0, 0)
ItemList.Parent = MainFrame

local UICornerList = Instance.new("UICorner")
UICornerList.CornerRadius = UDim.new(0, 6)
UICornerList.Parent = ItemList

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0, 5)
UIListLayout.Parent = ItemList

local UIPadding = Instance.new("UIPadding")
UIPadding.PaddingTop = UDim.new(0, 5)
UIPadding.PaddingLeft = UDim.new(0, 5)
UIPadding.PaddingRight = UDim.new(0, 5)
UIPadding.Parent = ItemList

-- ==========================================
-- FUNGSI PENCARI UUID DI INVENTORY
-- ==========================================
local function GetOwnedUUID(targetName)
    local InvController
    pcall(function()
        InvController = require(ReplicatedStorage.Controllers.InventoryController)
    end)
    if not InvController then return nil end

    local foundUUID = nil
    local visited = {}
    local uuidPattern = "^%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x$"

    local function scan(t, depth)
        if depth > 4 or visited[t] then return end
        visited[t] = true
        for k, v in pairs(t) do
            if type(k) == "string" and string.match(k, uuidPattern) and type(v) == "table" then
                for _, val in pairs(v) do
                    if type(val) == "string" and val == targetName then
                        foundUUID = k return
                    end
                end
            end
            if type(v) == "table" then
                local hasName, tempUUID = false, nil
                for _, val in pairs(v) do
                    if type(val) == "string" then
                        if val == targetName then hasName = true end
                        if string.match(val, uuidPattern) then tempUUID = val end
                    end
                end
                if hasName and tempUUID then foundUUID = tempUUID return end
                scan(v, depth + 1)
            end
            if foundUUID then return end
        end
    end

    scan(InvController, 1)
    return foundUUID
end

-- ==========================================
-- MEMUAT SEMUA GEAR DARI FOLDER SERVER
-- ==========================================
local gears = GearsFolder:GetChildren()
table.sort(gears, function(a, b) return a.Name < b.Name end) -- Urutkan Sesuai Abjad

for _, gearItem in ipairs(gears) do
    local itemName = gearItem.Name
    
    local ItemBtn = Instance.new("TextButton")
    ItemBtn.Size = UDim2.new(1, 0, 0, 35)
    ItemBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    ItemBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
    ItemBtn.Text = " " .. itemName
    ItemBtn.Font = Enum.Font.GothamSemibold
    ItemBtn.TextSize = 13
    ItemBtn.TextXAlignment = Enum.TextXAlignment.Left
    ItemBtn.AutoButtonColor = true
    ItemBtn.Parent = ItemList
    
    local UICornerItemBtn = Instance.new("UICorner")
    UICornerItemBtn.CornerRadius = UDim.new(0, 4)
    UICornerItemBtn.Parent = ItemBtn
    
    -- Fungsi Saat Tombol Diklik
    ItemBtn.MouseButton1Click:Connect(function()
        ItemBtn.Text = " ðŸ” Mengecek Tas..."
        ItemBtn.BackgroundColor3 = Color3.fromRGB(200, 150, 0) -- Kuning
        
        -- Cek apakah player benar-benar punya item ini
        local realUUID = GetOwnedUUID(itemName)
        
        if realUUID then
            ItemBtn.Text = " â³ Equipping..."
            ItemBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215) -- Biru
            
            -- Tembak server
            local args = {realUUID, itemName}
            Event:FireServer(unpack(args))
            
            task.wait(0.3)
            ItemBtn.Text = " âœ… Terpasang!"
            ItemBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69) -- Hijau
        else
            ItemBtn.Text = " âŒ Kamu Tidak Punya Ini!"
            ItemBtn.BackgroundColor3 = Color3.fromRGB(220, 53, 69) -- Merah
        end
        
        -- Kembalikan tombol seperti semula
        task.wait(1.5)
        ItemBtn.Text = " " .. itemName
        ItemBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    end)
end
