-- ====================================================
-- [MINI UI + AUTO MINING CONTROLLER]
-- ====================================================

-- [1] SERVICES & VARIABLES GLOBAL
local Services = {
    Workspace = game:GetService("Workspace"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Players = game:GetService("Players"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService"),
    RunService = game:GetService("RunService")
}

local LocalPlayer = Services.Players.LocalPlayer
local Camera = Services.Workspace.CurrentCamera

-- State Global (Agar bisa diakses UI dan Logic)
getgenv().States = {
    AutoCrystal = false, -- Default OFF
    IsMining = false
}

-- [2] HELPER FUNCTIONS (Supaya Logic Kamu Jalan)
local function GetRoot()
    return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
end

local function GetHum()
    return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
end

-- Fungsi Notifikasi Sederhana (Menggantikan Notify kamu jika belum ada)
local function Notify(title, text, color, duration)
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = title;
        Text = text;
        Duration = duration or 3;
    })
end

local function GetActiveNodes(folder)
    local nodes = {}
    for _, child in ipairs(folder:GetChildren()) do
        -- Masukkan logika filter node aktif disini (misal cek transparansi atau nama)
        if child:IsA("BasePart") or child:IsA("Model") then
            table.insert(nodes, child)
        end
    end
    return nodes
end

-- ====================================================
-- [UI CREATION - MINI TOGGLE]
-- ====================================================
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local UICorner = Instance.new("UICorner")
local TitleLabel = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local BtnCorner = Instance.new("UICorner")
local StatusLabel = Instance.new("TextLabel")

-- Protect UI
if syn and syn.protect_gui then syn.protect_gui(ScreenGui) end
ScreenGui.Parent = Services.CoreGui
ScreenGui.Name = "MiniMiningUI"

-- 1. Main Frame (Kecil & Rapi)
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.Position = UDim2.new(0.1, 0, 0.1, 0) -- Posisi Awal
MainFrame.Size = UDim2.new(0, 160, 0, 80) -- Ukuran Mini
MainFrame.Active = true
MainFrame.Draggable = true -- BISA DIGESER

UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- 2. Title
TitleLabel.Parent = MainFrame
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 0, 0, 5)
TitleLabel.Size = UDim2.new(1, 0, 0, 20)
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.Text = "AUTO MINING"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 12

-- 3. Toggle Button
ToggleBtn.Parent = MainFrame
ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60) -- Merah (OFF)
ToggleBtn.Position = UDim2.new(0.1, 0, 0.4, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0, 25)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Text = "OFF"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 14

BtnCorner.CornerRadius = UDim.new(0, 6)
BtnCorner.Parent = ToggleBtn

-- 4. Status Label (Bawah)
StatusLabel.Parent = MainFrame
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0, 0, 0.75, 0)
StatusLabel.Size = UDim2.new(1, 0, 0, 15)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Text = "Status: Idle"
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.TextSize = 10

-- ====================================================
-- [LOGIC KAMU: FINAL FIXED]
-- ====================================================

local Locations = {
    LavaBasin = CFrame.new(860.08, 85.86, -10094.87),
    CrystalDepths = CFrame.new(5820.14, -907.79, 15424.53)
}

-- [1] FUNGSI TELEPORT INSTAN
local function InstantTP(targetCFrame)
    local hrp = GetRoot()
    if hrp then 
        hrp.CFrame = targetCFrame 
    end
end

-- [2] FUNGSI MINING PER FOLDER
local function MineFolder(folderName)
    StatusLabel.Text = "Scanning: " .. folderName
    local Islands = Services.Workspace:WaitForChild("Islands", 10)
    if not Islands then return end
    
    local targetFolder
    if folderName == "Lava" then
        targetFolder = Islands:FindFirstChild("Lava Basin") and Islands["Lava Basin"]:FindFirstChild("Crystals")
    elseif folderName == "Deep" then
        targetFolder = Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
    end

    if not targetFolder then return end

    local activeNodes = GetActiveNodes(targetFolder)
    if #activeNodes == 0 then 
        Notify("MINING", "No Crystals in "..folderName, Color3.fromRGB(255, 200, 0))
        return 
    end

    Notify("MINING", "Mining "..folderName.." ("..#activeNodes.." Nodes)", Color3.fromRGB(0, 255, 255))

    for i, node in ipairs(activeNodes) do
        if not States.AutoCrystal then break end 
        StatusLabel.Text = "Mining: " .. folderName .. " #" .. i

        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            local crystalCF = node:IsA("Model") and node:GetPivot() or node.CFrame
            
            -- Hitung Posisi Depan
            local crystalPos = crystalCF.Position
            local frontPos = crystalPos + (crystalCF.LookVector * 3.5)
            frontPos = Vector3.new(frontPos.X, crystalPos.Y, frontPos.Z)
            local finalCFrame = CFrame.lookAt(frontPos, crystalPos)
            
            -- EKSEKUSI
            InstantTP(finalCFrame)
            task.wait(0.5) 
            
            fireproximityprompt(prompt)
            -- JEDA 7 DETIK SETELAH AMBIL
            task.wait(7)
        end
    end
end

-- [3] ROUTINE UTAMA
local function FullMiningRoutine()
    local hrp = GetRoot()
    local hum = GetHum()
    if not hrp or not hum then return end
    
    States.IsMining = true
    StatusLabel.Text = "Starting Routine..."
    
    -- A. SAVE POSITION
    local SavedPosition = hrp.CFrame
    Notify("ROUTE", "Position Saved.", Color3.fromRGB(0, 255, 100))
    
    -- B. INSTANT TP TO LAVA BASIN
    StatusLabel.Text = "TP: Lava Basin"
    InstantTP(Locations.LavaBasin)
    task.wait(7) 
    
    -- C. GANTI ALAT (PICKAXE)
    hum:UnequipTools()
    task.wait(0.3)
    -- Pastikan path RemoteEquip benar sesuai game kamu
    local RemoteEquip = Services.ReplicatedStorage:FindFirstChild("Packages") 
        and Services.ReplicatedStorage.Packages:FindFirstChild("_Index") 
        and Services.ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RE/EquipToolFromHotbar"]
    
    if RemoteEquip then
        pcall(function() RemoteEquip:FireServer(2) end)
    end
    task.wait(1.5)
    
    -- D. SCAN & MINE LAVA
    MineFolder("Lava")
    
    -- E. SELESAI LAVA -> JEDA
    StatusLabel.Text = "Lava Done. Wait..."
    task.wait(7)
    
    -- F. INSTANT TP TO CRYSTAL DEPTHS
    if States.AutoCrystal then
        StatusLabel.Text = "TP: Crystal Depths"
        InstantTP(Locations.CrystalDepths)
        task.wait(7)
        
        -- G. MINE CRYSTAL DEPTHS
        MineFolder("Deep")
    end
    
    -- H. BACK TO SAVE POS
    StatusLabel.Text = "Going Home..."
    InstantTP(SavedPosition)
    
    -- I. GANTI KE ROD
    hum:UnequipTools()
    if RemoteEquip then
        pcall(function() RemoteEquip:FireServer(1) end)
    end
    States.IsMining = false
    StatusLabel.Text = "Status: Idle"
end

-- [4] JADWAL WAKTU
local function CheckSchedule()
    local now = os.date("!*t")
    local hourWIB = (now.hour + 7) % 24
    local min = now.min
    
    local isEvenHour = (hourWIB % 2 == 0)
    local isWindowOpen = (min >= 0 and min <= 40)
    
    if isEvenHour and isWindowOpen then
        return true
    else
        return false
    end
end

-- ====================================================
-- [BUTTON EVENT & LOOP]
-- ====================================================

-- Event Tombol ON/OFF
ToggleBtn.MouseButton1Click:Connect(function()
    States.AutoCrystal = not States.AutoCrystal
    
    if States.AutoCrystal then
        ToggleBtn.Text = "ON"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100) -- Hijau
        Notify("SYSTEM", "Auto Mining Activated", Color3.fromRGB(0, 255, 0))
    else
        ToggleBtn.Text = "OFF"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60) -- Merah
        StatusLabel.Text = "Status: Stopped"
        Notify("SYSTEM", "Auto Mining Deactivated", Color3.fromRGB(255, 0, 0))
    end
end)

-- Loop Utama
local HasRunThisCycle = false 

task.spawn(function()
    while true do
        if States.AutoCrystal then
            local isOpen = CheckSchedule()
            
            if isOpen then
                if not HasRunThisCycle then
                    StatusLabel.Text = "Schedule OPEN!"
                    FullMiningRoutine()
                    HasRunThisCycle = true 
                    Notify("COOLDOWN", "Cycle Done.", Color3.fromRGB(150, 150, 150))
                else
                    StatusLabel.Text = "Waiting Next Schedule..."
                end
            else
                StatusLabel.Text = "Schedule CLOSED"
                HasRunThisCycle = false
            end
            
            task.wait(5)
        else
            -- Jika dimatikan lewat UI
            HasRunThisCycle = false
            task.wait(2)
        end
    end
end)
