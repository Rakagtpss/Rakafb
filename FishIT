-- [[ MINI MINING HUB V5.9 - FINAL REVISION ]]
-- [[ STRICT UNIFIED LOGIC: SAME METHOD FOR CRYSTAL & LAVA ]]
-- [[ FRONT POSITION FIX: TRUE OFFSET ]]

local Services = {
    Players = game:GetService("Players"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Workspace = game:GetService("Workspace"),
    TweenService = game:GetService("TweenService"),
    CoreGui = game:GetService("CoreGui")
}

local Player = Services.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- // 1. UI RESET & SETUP
if Services.CoreGui:FindFirstChild("MiniMiningUI") then Services.CoreGui.MiniMiningUI:Destroy() end
if PlayerGui:FindFirstChild("MiniMiningUI") then PlayerGui.MiniMiningUI:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MiniMiningUI"
pcall(function() ScreenGui.Parent = Services.CoreGui end)
if not ScreenGui.Parent then ScreenGui.Parent = PlayerGui end

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 220, 0, 150)
MainFrame.Position = UDim2.new(0.5, -110, 0.25, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
MainFrame.BorderSizePixel = 0
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

local Title = Instance.new("TextLabel", MainFrame)
Title.Text = "MINING HUB V5.9 (FINAL)"
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 12

local StatusLabel = Instance.new("TextLabel", MainFrame)
StatusLabel.Text = "Status: Standby"
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.Position = UDim2.new(0, 0, 1, -20)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 10

local function Notify(msg, color)
    StatusLabel.Text = msg
    StatusLabel.TextColor3 = color or Color3.new(1,1,1)
end

-- // 2. REMOTE SETUP (USER PROVIDED PATH)
local RemoteEquip = nil
pcall(function()
    RemoteEquip = Services.ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net["RE/EquipToolFromHotbar"]
end)

if not RemoteEquip then
    Notify("Critical: Remote Not Found!", Color3.fromRGB(255, 0, 0))
else
    Notify("System Ready.", Color3.fromRGB(0, 255, 0))
end

-- // 3. MOVEMENT & POSITION LOGIC
local function GetRoot() return Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") end
local function GetHum() return Player.Character and Player.Character:FindFirstChild("Humanoid") end

local function SafeTween(targetCF)
    local hrp = GetRoot()
    if not hrp then return end
    
    local dist = (hrp.Position - targetCF.Position).Magnitude
    if dist < 3 then hrp.CFrame = targetCF; return end -- Instant jika dekat
    
    local speed = 65 -- Kecepatan Tween
    local time = math.max(0.2, dist / speed)
    
    local ti = TweenInfo.new(time, Enum.EasingStyle.Linear)
    local tw = Services.TweenService:Create(hrp, ti, {CFrame = targetCF})
    tw:Play()
    tw.Completed:Wait()
    hrp.AssemblyLinearVelocity = Vector3.zero
end

-- // 4. CORE MINING LOGIC (SATU FUNGSI UNTUK SEMUA)
local States = { Crystal = false, Lava = false, IsMining = false }

local function PerformMining(AreaName, ToggleKey)
    -- Cek Folder
    local Islands = Services.Workspace:FindFirstChild("Islands")
    if not Islands then return end
    
    local AreaFolder = Islands:FindFirstChild(AreaName)
    if not AreaFolder then return end
    
    local CrystalFolder = AreaFolder:FindFirstChild("Crystals")
    if not CrystalFolder then return end

    -- Cek Nodes Aktif
    local activeNodes = {}
    for _, node in ipairs(CrystalFolder:GetChildren()) do
        if node:FindFirstChild("ProximityPrompt", true) and node:FindFirstChild("ProximityPrompt", true).Enabled then
            table.insert(activeNodes, node)
        end
    end

    if #activeNodes == 0 then return end -- Tidak ada spawn, diam saja

    -- MULAI SEQUENCE
    States.IsMining = true
    Notify("Spawn Detected: " .. AreaName, Color3.fromRGB(0, 255, 255))
    
    local hrp = GetRoot()
    local savedPos = hrp.CFrame -- Simpan posisi mancing

    -- 1. Equip Pickaxe (Slot 2)
    pcall(function() RemoteEquip:FireServer(2) end)
    task.wait(0.5)

    -- 2. Activate Fly Mode
    local hum = GetHum()
    if hum then hum.PlatformStand = true end
    local bv = Instance.new("BodyVelocity")
    bv.Name = "MiningVel"
    bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bv.Velocity = Vector3.zero
    bv.Parent = hrp

    -- 3. Loop Mining Node
    for i, node in ipairs(activeNodes) do
        if not States[ToggleKey] then break end -- Emergency Stop
        hrp = GetRoot()
        if not hrp then break end

        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            -- [POSISI FIX: DI DEPAN]
            -- Menggunakan GetPivot untuk akurasi Model
            local nodeCF = node:IsA("Model") and node:GetPivot() or node.CFrame
            
            -- Logika:
            -- 1. Ambil posisi node
            -- 2. Mundur 4 studs dari arah node menghadap (LookVector * 4)
            -- 3. LookAt kembali ke node agar karakter menghadap node
            
            local targetPos = nodeCF.Position + (nodeCF.LookVector * 3.5) -- Mundur 3.5 studs sesuai arah node
            local finalCF = CFrame.lookAt(targetPos, nodeCF.Position)
            
            -- Jika posisi di bawah tanah/map (Y terlalu rendah), naikkan sedikit
            if finalCF.Y < nodeCF.Y then
                finalCF = finalCF + Vector3.new(0, 3, 0)
            end

            Notify("Mining: " .. i .. "/" .. #activeNodes, Color3.fromRGB(255, 170, 0))
            SafeTween(finalCF)
            
            task.wait(0.2)
            fireproximityprompt(prompt)
            
            -- Wait Logic (Tunggu sampai node hilang atau prompt mati)
            local t = 0
            while prompt.Enabled and t < 8 do
                task.wait(0.5); t = t + 0.5
            end
        end
    end

    -- 4. Selesai - Bersihkan
    if hrp:FindFirstChild("MiningVel") then hrp.MiningVel:Destroy() end
    if hum then hum.PlatformStand = false end
    hrp.AssemblyLinearVelocity = Vector3.zero

    -- 5. Kembali ke posisi awal
    Notify("Returning...", Color3.fromRGB(0, 200, 255))
    SafeTween(savedPos)
    
    -- 6. Equip Rod (Slot 1)
    pcall(function() RemoteEquip:FireServer(1) end)
    
    States.IsMining = false
    Notify("Idle (Waiting Spawn)", Color3.fromRGB(150, 150, 150))
end

-- // 5. UI CONTROLS
local function CreateBtn(txt, y, key, area)
    local btn = Instance.new("TextButton", MainFrame)
    btn.Text = txt .. " [OFF]"
    btn.Size = UDim2.new(0.9, 0, 0, 30)
    btn.Position = UDim2.new(0.05, 0, 0, y)
    btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
    btn.TextColor3 = Color3.fromRGB(180,180,180)
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    
    btn.MouseButton1Click:Connect(function()
        States[key] = not States[key]
        if States[key] then
            btn.Text = txt .. " [ON]"
            btn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
            btn.TextColor3 = Color3.new(1,1,1)
        else
            btn.Text = txt .. " [OFF]"
            btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
            btn.TextColor3 = Color3.fromRGB(180,180,180)
            States.IsMining = false -- Reset flag
            
            -- Force Stop Physics
            local h = GetRoot()
            if h and h:FindFirstChild("MiningVel") then h.MiningVel:Destroy() end
            local hu = GetHum()
            if hu then hu.PlatformStand = false end
        end
    end)
end

CreateBtn("Auto Crystal", 35, "Crystal", "Crystal Depths")
CreateBtn("Auto Lava", 70, "Lava", "Lava Basin")

-- // 6. MAIN LOOPS
-- Menggunakan Spawn Function terpisah agar tidak saling blocking
task.spawn(function()
    while true do
        task.wait(1)
        if States.Crystal and not States.IsMining then
            pcall(function() PerformMining("Crystal Depths", "Crystal") end)
        end
    end
end)

task.spawn(function()
    while true do
        task.wait(1)
        if States.Lava and not States.IsMining then
            pcall(function() PerformMining("Lava Basin", "Lava") end)
        end
    end
end)

-- Draggable
local dragging, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true; dragStart = input.Position; startPos = MainFrame.Position
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
MainFrame.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end end)
