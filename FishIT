-- [[ SERAPHIN MINI UI - FINAL FIX (FORCE SWAP & MINING STATE) ]]
-- Version: Mini V2.0 (Stable Mining & Anti-Interference)

local Services = {
    Players = game:GetService("Players"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    Lighting = game:GetService("Lighting"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    TweenService = game:GetService("TweenService"),
    Workspace = game:GetService("Workspace"),
    UserInputService = game:GetService("UserInputService")
}

local Player = Services.Players.LocalPlayer
local Camera = Services.Workspace.CurrentCamera

-- // THEME CONFIG
local UI = {
    Color = Color3.fromRGB(15, 15, 20),
    Accent = Color3.fromRGB(255, 50, 50), -- Warna Merah (Indikator Kuat)
    Text = Color3.fromRGB(240, 240, 240),
    Size = UDim2.new(0, 220, 0, 300)
}

-- // CLEANUP OLD UI
if Services.CoreGui:FindFirstChild("SeraphinMini") then 
    Services.CoreGui.SeraphinMini:Destroy() 
end

-- // CREATE UI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SeraphinMini"
ScreenGui.Parent = Services.CoreGui
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Name = "MainFrame"
MainFrame.Size = UI.Size
MainFrame.Position = UDim2.new(0, 20, 0.5, -150)
MainFrame.BackgroundColor3 = UI.Color
MainFrame.BorderSizePixel = 0
MainFrame.BackgroundTransparency = 0.1
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

-- Header
local Header = Instance.new("Frame", MainFrame)
Header.Size = UDim2.new(1, 0, 0, 30)
Header.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
Header.BackgroundTransparency = 0.95
Instance.new("UICorner", Header).CornerRadius = UDim.new(0, 8)

local Title = Instance.new("TextLabel", Header)
Title.Size = UDim2.new(1, -40, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.Text = "SERAPHIN <font color='#ff3232'>FIX</font>"
Title.RichText = true
Title.Font = Enum.Font.GothamBlack
Title.TextSize = 12
Title.TextColor3 = UI.Text
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.BackgroundTransparency = 1

local MiniBtn = Instance.new("TextButton", Header)
MiniBtn.Size = UDim2.new(0, 30, 0, 30)
MiniBtn.Position = UDim2.new(1, -30, 0, 0)
MiniBtn.Text = "-"
MiniBtn.Font = Enum.Font.GothamBold
MiniBtn.TextSize = 14
MiniBtn.TextColor3 = UI.Text
MiniBtn.BackgroundTransparency = 1

-- Scroll Container
local Scroll = Instance.new("ScrollingFrame", MainFrame)
Scroll.Size = UDim2.new(1, -10, 1, -40)
Scroll.Position = UDim2.new(0, 5, 0, 35)
Scroll.BackgroundTransparency = 1
Scroll.ScrollBarThickness = 2
Scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
Scroll.CanvasSize = UDim2.new(0,0,0,0)

local UIList = Instance.new("UIListLayout", Scroll)
UIList.Padding = UDim.new(0, 6)
UIList.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- // HELPER FUNCTIONS
local function Drag(frame)
    local dragToggle, dragStart, startPos
    local function updateInput(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragToggle = true; dragStart = input.Position; startPos = frame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragToggle = false end end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            if dragToggle then updateInput(input) end
        end
    end)
end
Drag(MainFrame)

-- // STATES
local States = {
    AutoCrystal = false,
    AutoLava = false,
    AutoEvent = false,
    WoW = false,
    Noclip = false,
    IsMining = false, -- Status Mining
    AutoEquip = false -- Status Auto Equip Rod
}

-- // TOGGLE CREATOR
local function CreateToggle(text, stateVar, callback)
    local Btn = Instance.new("TextButton", Scroll)
    Btn.Size = UDim2.new(0.95, 0, 0, 32)
    Btn.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    Btn.Text = ""
    Btn.AutoButtonColor = false
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)

    local Lbl = Instance.new("TextLabel", Btn)
    Lbl.Size = UDim2.new(0.7, 0, 1, 0)
    Lbl.Position = UDim2.new(0, 10, 0, 0)
    Lbl.Text = text
    Lbl.Font = Enum.Font.GothamBold
    Lbl.TextSize = 10
    Lbl.TextColor3 = Color3.fromRGB(200, 200, 200)
    Lbl.TextXAlignment = Enum.TextXAlignment.Left
    Lbl.BackgroundTransparency = 1

    local Indicator = Instance.new("Frame", Btn)
    Indicator.Size = UDim2.new(0, 8, 0, 8)
    Indicator.Position = UDim2.new(1, -20, 0.5, -4)
    Indicator.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    Instance.new("UICorner", Indicator).CornerRadius = UDim.new(1, 0)

    local IsOn = false
    Btn.MouseButton1Click:Connect(function()
        IsOn = not IsOn
        States[stateVar] = IsOn
        
        Services.TweenService:Create(Indicator, TweenInfo.new(0.2), {
            BackgroundColor3 = IsOn and UI.Accent or Color3.fromRGB(50, 50, 60)
        }):Play()
        
        Services.TweenService:Create(Lbl, TweenInfo.new(0.2), {
            TextColor3 = IsOn and Color3.new(1,1,1) or Color3.fromRGB(200, 200, 200)
        }):Play()

        if callback then callback(IsOn) end
    end)
    return Btn
end

-- // MINIMIZE LOGIC
local IsMin = false
local OpenBtn = Instance.new("TextButton", ScreenGui)
OpenBtn.Size = UDim2.new(0, 40, 0, 40)
OpenBtn.Position = UDim2.new(0, 20, 0.5, -20)
OpenBtn.BackgroundColor3 = UI.Color
OpenBtn.Text = "S"
OpenBtn.Font = Enum.Font.GothamBlack
OpenBtn.TextColor3 = UI.Accent
OpenBtn.Visible = false
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(0, 12)
Drag(OpenBtn)

MiniBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = false
    OpenBtn.Visible = true
end)
OpenBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = true
    OpenBtn.Visible = false
end)

-- ====================================================
-- [CORE LOGIC] SMART MINING V5 (FORCE SWAP & STATE LOCK)
-- ====================================================

local function GetChar() return Player.Character or Player.CharacterAdded:Wait() end
local function GetRoot() local c = Player.Character; return c and c:FindFirstChild("HumanoidRootPart") end
local function GetHum() local c = Player.Character; return c and c:FindFirstChild("Humanoid") end

local function GetActiveNodes(folder)
    local activeList = {}
    if not folder then return activeList end
    for _, item in ipairs(folder:GetChildren()) do
        if item:IsA("Model") or item:IsA("BasePart") then
            local prompt = item:FindFirstChildWhichIsA("ProximityPrompt", true)
            if prompt and prompt.Enabled then table.insert(activeList, item) end
        end
    end
    return activeList
end

-- [AI DELAY]
local function SmartWait(min, max)
    local randomDelay = math.random(min * 100, max * 100) / 100
    task.wait(randomDelay)
end

-- [FUNGSI PAKSA KOSONGKAN TANGAN]
local function ForceClearHand()
    local char = Player.Character
    if not char then return end
    for _, t in pairs(char:GetChildren()) do
        if t:IsA("Tool") then
            t.Parent = Player.Backpack -- Pindah ke Tas (Instan)
        end
    end
end

-- [FUNGSI EQUIP DARI TAS]
local function ForceEquipBag(keyword)
    local char = Player.Character
    local backpack = Player.Backpack
    if not char or not backpack then return false end
    
    for _, t in pairs(backpack:GetChildren()) do
        if t:IsA("Tool") and string.find(string.lower(t.Name), keyword) then
            t.Parent = char -- Pindah ke Tangan (Instan)
            return true
        end
    end
    return false
end

local function SmartMining(folder, toggleState)
    local activeNodes = GetActiveNodes(folder)
    if #activeNodes == 0 then return false end
    
    local hrp, char, hum = GetRoot(), GetChar(), GetHum()
    if not hrp or not char or not hum then return false end

    local RemoteEquip = Services.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index"):WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):WaitForChild("RE/EquipToolFromHotbar")

    -- [CRITICAL] LOCK STATE MINING
    States.IsMining = true -- Ini akan memblokir Auto Equip Rod
    local SafeReturnPos = hrp.CFrame
    
    -- [STEP 1] FORCE REMOVE ROD (SWAP PARENT)
    hrp.Anchored = true 
    ForceClearHand() 
    SmartWait(0.2, 0.3)
    ForceClearHand() -- Double Check
    
    -- [STEP 2] EQUIP PICKAXE
    local equipped = ForceEquipBag("pick") -- Coba cari manual dulu
    
    if not equipped then
        -- Kalau gak ketemu di tas, pakai Remote Slot 2
        pcall(function() RemoteEquip:FireServer(2) end)
    end
    
    SmartWait(1.2, 1.5) -- Tunggu Sync
    
    -- Validasi Akhir: Kalau masih pegang Rod, paksa lepas lagi
    if char:FindFirstChild("Rod") or char:FindFirstChild("Fishing Rod") then
        ForceClearHand()
        if equipped then ForceEquipBag("pick") end
    end
    
    hrp.Anchored = false 

    -- [STEP 3] MINING LOOP (FLOAT 3.5 STUD)
    for i, node in ipairs(activeNodes) do
        if not States[toggleState] then break end
        
        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            local targetCF = nil
            if node:IsA("Model") then targetCF = node:GetPivot()
            elseif node:IsA("BasePart") then targetCF = node.CFrame end
            
            if targetCF then
                hrp.Anchored = false 
                
                -- Jarak 3.5 Stud (Ideal untuk Mining)
                hrp.CFrame = targetCF + Vector3.new(0, 3.5, 0) 
                hrp.AssemblyLinearVelocity = Vector3.zero
                
                task.wait(0.05)
                hrp.Anchored = true -- Bekukan
                
                SmartWait(0.5, 0.7) -- Delay "Manusia" melihat prompt
                
                fireproximityprompt(prompt) -- TEKAN E
                
                -- Tunggu Mining Selesai (Durasi animasi)
                SmartWait(2.3, 2.6) 
            end
        end
    end

    -- [STEP 4] SELESAI & KEMBALI
    hrp.Anchored = false
    hrp.CFrame = SafeReturnPos
    hrp.AssemblyLinearVelocity = Vector3.zero
    
    SmartWait(0.5, 0.7)
    
    ForceClearHand() -- Lepas Pickaxe
    
    SmartWait(0.8, 1.0)
    
    -- Ambil Rod Kembali
    pcall(function() RemoteEquip:FireServer(1) end) 
    
    SmartWait(1.0, 1.2)
    States.IsMining = false -- Buka Lock Mining
    return true
end

-- ====================================================
-- [LOOPS & BUTTONS]
-- ====================================================

CreateToggle("Auto Equip Rod", "AutoEquip", nil) -- Tombol Auto Equip

CreateToggle("Auto Crystal (Safe)", "AutoCrystal", function(val)
    if val then States.WoW = true else States.WoW = false end
end)

CreateToggle("Auto Lava (Safe)", "AutoLava", function(val)
    if val then States.WoW = true else States.WoW = false end
end)

CreateToggle("Auto Event Hunt", "AutoEvent", function(val)
    if val then States.WoW = true else States.WoW = false end
end)

CreateToggle("Walk on Water", "WoW", function(val)
    if val then
        local hrp = GetRoot()
        local bv = Instance.new("BodyVelocity")
        bv.Name = "SeraphinWoW"
        bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bv.Velocity = Vector3.zero
        bv.Parent = hrp
    else
        local hrp = GetRoot()
        if hrp and hrp:FindFirstChild("SeraphinWoW") then hrp.SeraphinWoW:Destroy() end
    end
end)

CreateToggle("Noclip", "Noclip", nil)

-- [LOGIC LOOPS]

-- Auto Equip Loop (DENGAN PENGECEKAN ISMINING)
task.spawn(function()
    while true do
        if States.AutoEquip and not States.IsMining then -- PENTING: Cek IsMining
            local char = Player.Character
            if char and not (char:FindFirstChild("Rod") or char:FindFirstChild("Fishing Rod")) then
                local RemoteEquip = Services.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index"):WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net"):FindFirstChild("RE/EquipToolFromHotbar")
                if RemoteEquip then pcall(function() RemoteEquip:FireServer(1) end) end
            end
        end
        task.wait(2)
    end
end)

-- WoW Loop
Services.RunService.RenderStepped:Connect(function()
    if States.WoW then
        local hrp = GetRoot()
        local hum = GetHum()
        if hrp and hum and hrp:FindFirstChild("SeraphinWoW") then
            local move = hum.MoveDirection
            if move.Magnitude > 0 then
                hrp.SeraphinWoW.Velocity = Vector3.new(move.X * hum.WalkSpeed, 0, move.Z * hum.WalkSpeed)
            else
                hrp.SeraphinWoW.Velocity = Vector3.zero
            end
        end
    end
end)

-- Noclip Loop
Services.RunService.Stepped:Connect(function()
    if States.Noclip then
        local c = GetChar()
        if c then
            for _, v in pairs(c:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
    end
end)

-- Mining Loops
task.spawn(function()
    while true do
        if States.AutoCrystal then
            local Islands = Services.Workspace:WaitForChild("Islands", 5)
            local Folder = Islands and Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
            if Folder then
                local done = SmartMining(Folder, "AutoCrystal")
                if done then SmartWait(5.0, 7.0) else SmartWait(2.0, 3.0) end
            end
        end
        task.wait(1)
    end
end)

task.spawn(function()
    while true do
        if States.AutoLava then
            local Islands = Services.Workspace:WaitForChild("Islands", 5)
            local Folder = Islands and Islands:FindFirstChild("Lava Basin") and Islands["Lava Basin"]:FindFirstChild("Crystals")
            if Folder then
                local done = SmartMining(Folder, "AutoLava")
                if done then SmartWait(5.0, 7.0) else SmartWait(2.0, 3.0) end
            end
        end
        task.wait(1)
    end
end)

-- Event Loop
local EventList = {"Ghost Shark", "Worm", "Treasure", "Shark", "Megalodon"}
task.spawn(function()
    while true do
        if States.AutoEvent then
            local hrp = GetRoot()
            if hrp then
                local folders = {Services.Workspace:FindFirstChild("ActiveEvents"), Services.Workspace:FindFirstChild("Props")}
                for _, f in pairs(folders) do
                    if f then
                        for _, v in pairs(f:GetChildren()) do
                            for _, name in pairs(EventList) do
                                if string.find(v.Name, name) then
                                    local pos = v:GetPivot().Position
                                    if (hrp.Position - Vector3.new(pos.X, 4, pos.Z)).Magnitude > 10 then
                                        hrp.CFrame = CFrame.new(pos.X, 4, pos.Z)
                                        hrp.AssemblyLinearVelocity = Vector3.zero
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        SmartWait(2.0, 3.5)
    end
end)
