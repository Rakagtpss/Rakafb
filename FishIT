local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- --- 1. SETUP REMOTE FUNCTIONS ---
local Packages = ReplicatedStorage:WaitForChild("Packages")
local Index = Packages:WaitForChild("_Index")
local Sleitnick = Index:WaitForChild("sleitnick_net@0.2.0")
local NetFolder = Sleitnick:WaitForChild("net")

local Remotes = {
    ChargeRod = NetFolder:WaitForChild("RF/ChargeFishingRod"),
    CatchCompleted = NetFolder:WaitForChild("RF/CatchFishCompleted"),
    CancelInputs = NetFolder:WaitForChild("RF/CancelFishingInputs"),
    RequestMinigame = NetFolder:WaitForChild("RF/RequestFishingMinigameStarted"),
    UpdateState = NetFolder:WaitForChild("RF/UpdateAutoFishingState"),
}

-- --- 2. CONFIG VARIABLE ---
local Config = {
    IsActive = false,
    MinShakeDelay = 0.5, -- Waktu tunggu minimal
    MaxShakeDelay = 1.0, -- Waktu tunggu maksimal
    CastPower = 95,      -- Kekuatan lempar (Simulasi 0 - 100)
}

-- --- 3. UI GENERATION (Tampilan Dark Mode) ---
if getgenv and getgenv().FishUI then getgenv().FishUI:Destroy() end
if CoreGui:FindFirstChild("FishingConfigUI") then CoreGui.FishingConfigUI:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FishingConfigUI"
if pcall(function() ScreenGui.Parent = CoreGui end) then else ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

-- Frame Utama
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 260, 0, 210)
MainFrame.Position = UDim2.new(0.5, -130, 0.5, -105)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui
local UICorner = Instance.new("UICorner"); UICorner.CornerRadius = UDim.new(0, 10); UICorner.Parent = MainFrame

-- Judul
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 35)
Title.BackgroundTransparency = 1
Title.Text = "üé£ Auto Fish + Shake"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.Parent = MainFrame

-- Status Label
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.Position = UDim2.new(0, 0, 0, 30)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Status: Idle"
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 12
StatusLabel.Parent = MainFrame

-- Input Min Delay
local MinInput = Instance.new("TextBox")
MinInput.Size = UDim2.new(0, 100, 0, 35)
MinInput.Position = UDim2.new(0, 20, 0, 70)
MinInput.PlaceholderText = "Min (s)"
MinInput.Text = tostring(Config.MinShakeDelay)
MinInput.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
MinInput.TextColor3 = Color3.fromRGB(255, 255, 255)
MinInput.Font = Enum.Font.Gotham
MinInput.Parent = MainFrame
local MinCorner = Instance.new("UICorner"); MinCorner.CornerRadius = UDim.new(0, 6); MinCorner.Parent = MinInput

MinInput.FocusLost:Connect(function()
    Config.MinShakeDelay = tonumber(MinInput.Text) or Config.MinShakeDelay
end)

-- Input Max Delay
local MaxInput = Instance.new("TextBox")
MaxInput.Size = UDim2.new(0, 100, 0, 35)
MaxInput.Position = UDim2.new(0, 140, 0, 70)
MaxInput.PlaceholderText = "Max (s)"
MaxInput.Text = tostring(Config.MaxShakeDelay)
MaxInput.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
MaxInput.TextColor3 = Color3.fromRGB(255, 255, 255)
MaxInput.Font = Enum.Font.Gotham
MaxInput.Parent = MainFrame
local MaxCorner = Instance.new("UICorner"); MaxCorner.CornerRadius = UDim.new(0, 6); MaxCorner.Parent = MaxInput

MaxInput.FocusLost:Connect(function()
    Config.MaxShakeDelay = tonumber(MaxInput.Text) or Config.MaxShakeDelay
end)

-- Tombol Toggle
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(0, 220, 0, 45)
ToggleBtn.Position = UDim2.new(0, 20, 0, 130)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60) -- Merah
ToggleBtn.Text = "START FISHING"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextSize = 16
ToggleBtn.Parent = MainFrame
local BtnCorner = Instance.new("UICorner"); BtnCorner.CornerRadius = UDim.new(0, 8); BtnCorner.Parent = ToggleBtn

-- Drag Logic (Agar UI bisa digeser)
local dragging, dragInput, dragStart, startPos
local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true; dragStart = input.Position; startPos = MainFrame.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
end)
UserInputService.InputChanged:Connect(function(input) if input == dragInput and dragging then update(input) end end)

-- --- 4. LOGIKA UTAMA (Sesuai Remote Log) ---

local function FishingRoutine()
    task.spawn(function()
        while Config.IsActive do
            -- A. CHARGE ROD (Melempar Kail)
            StatusLabel.Text = "Casting Rod..."
            
            -- Menggunakan GetServerTimeNow() agar timestamp valid
            local chargeTime = workspace:GetServerTimeNow()
            Remotes.ChargeRod:InvokeServer(chargeTime)
            
            -- Tunggu animasi lempar & tunggu ikan menggigit
            -- (Kita gunakan delay acak untuk simulasi "Shake Delay")
            local shakeDelay = Config.MinShakeDelay + (math.random() * (Config.MaxShakeDelay - Config.MinShakeDelay))
            StatusLabel.Text = "Waiting Delay: " .. string.format("%.2f", shakeDelay) .. "s"
            task.wait(2.5 + shakeDelay) -- 2.5s animasi dasar + delay kustom
            
            if not Config.IsActive then break end

            -- B. REQUEST MINIGAME
            StatusLabel.Text = "Starting Minigame..."
            -- Argumen: (Power/Distance, Difficulty/BarSize, Timestamp)
            -- Kita pakai Power random 90-100 agar terlihat legit, BarSize 0.5 sesuai log kamu
            local minigameTime = workspace:GetServerTimeNow()
            Remotes.RequestMinigame:InvokeServer(Config.CastPower, 0.5, minigameTime)
            
            -- Tunggu sebentar (simulasi main minigame)
            task.wait(1) 
            
            -- C. CATCH FISH (Menangkap)
            StatusLabel.Text = "Catching Fish..."
            Remotes.CatchCompleted:InvokeServer()
            
            -- D. COOLDOWN
            StatusLabel.Text = "Cooldown..."
            task.wait(1.5)
        end
        
        -- Reset jika berhenti
        StatusLabel.Text = "Stopped."
        Remotes.CancelFishingInputs:InvokeServer() -- Reset input agar char tidak bug
        Remotes.UpdateState:InvokeServer(false)
    end)
end

-- --- 5. EVENT HANDLER ---

ToggleBtn.MouseButton1Click:Connect(function()
    Config.IsActive = not Config.IsActive
    
    if Config.IsActive then
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(60, 180, 60) -- Hijau
        ToggleBtn.Text = "STOP FISHING"
        print("‚úÖ Auto Fish Started")
        FishingRoutine()
    else
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60) -- Merah
        ToggleBtn.Text = "START FISHING"
        print("‚èπ Auto Fish Stopped")
    end
end)

-- Simpan instance UI ke global agar tidak duplikat
if getgenv then getgenv().FishUI = ScreenGui end
