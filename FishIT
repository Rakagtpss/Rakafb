-- ====================================================
-- [FINAL V14] SMART CHECK + AUTO RETURN IF EMPTY
-- FEATURE: ON/OFF LANGSUNG CEK WAKTU & CRYSTAL
-- ====================================================

local Services = {
    Workspace = game:GetService("Workspace"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    Players = game:GetService("Players"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService"),
    RunService = game:GetService("RunService")
}

local LocalPlayer = Services.Players.LocalPlayer
local NetPath = Services.ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"].net

getgenv().States = {
    AutoCrystal = false,
    IsMining = false,
    IsFishing = false,
    SavedHomeCFrame = nil -- Menyimpan posisi awal sebelum mining
}

local Locations = {
    LavaBasin = CFrame.new(860.08, 85.86, -10094.87),
    CrystalDepths = CFrame.new(5820.14, -907.79, 15424.53)
}

-- ====================================================
-- [UI SETUP]
-- ====================================================
if game:GetService("CoreGui"):FindFirstChild("MiniMiningV14") then
    game:GetService("CoreGui").MiniMiningV14:Destroy()
end

local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local UICorner = Instance.new("UICorner")
local TitleLabel = Instance.new("TextLabel")
local ToggleBtn = Instance.new("TextButton")
local BtnCorner = Instance.new("UICorner")
local StatusLabel = Instance.new("TextLabel")

if syn and syn.protect_gui then syn.protect_gui(ScreenGui) end
ScreenGui.Parent = Services.CoreGui
ScreenGui.Name = "MiniMiningV14"

MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(15, 20, 30)
MainFrame.Position = UDim2.new(0.05, 0, 0.2, 0)
MainFrame.Size = UDim2.new(0, 220, 0, 130)
MainFrame.Active = true
MainFrame.Draggable = true
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

TitleLabel.Parent = MainFrame
TitleLabel.BackgroundTransparency = 1
TitleLabel.Position = UDim2.new(0, 0, 0, 8)
TitleLabel.Size = UDim2.new(1, 0, 0, 20)
TitleLabel.Font = Enum.Font.GothamBlack
TitleLabel.Text = "AUTO MINING V14"
TitleLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
TitleLabel.TextSize = 14

ToggleBtn.Parent = MainFrame
ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
ToggleBtn.Position = UDim2.new(0.1, 0, 0.35, 0)
ToggleBtn.Size = UDim2.new(0.8, 0, 0, 35)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Text = "START SYSTEM"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 14
BtnCorner.CornerRadius = UDim.new(0, 6)
BtnCorner.Parent = ToggleBtn

StatusLabel.Parent = MainFrame
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0, 0, 0.75, 0)
StatusLabel.Size = UDim2.new(1, 0, 0, 15)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.Text = "Status: Idle"
StatusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
StatusLabel.TextSize = 11

-- ====================================================
-- [CORE PHYSICS & UTILS]
-- ====================================================

local function GetRoot() return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") end
local function GetHum() return LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") end
local function Notify(msg, color) 
    StatusLabel.Text = msg
    StatusLabel.TextColor3 = color or Color3.fromRGB(255, 255, 255) 
end

local function SetAnchor(bool)
    local hrp = GetRoot()
    if hrp then 
        hrp.Anchored = bool
        if bool then hrp.Velocity = Vector3.zero end 
    end
end

local function EnableNoClip()
    local Connection = Services.RunService.Stepped:Connect(function()
        if not States.AutoCrystal then return end 
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") and part.CanCollide == true then 
                    part.CanCollide = false 
                end
            end
        end
    end)
    return Connection
end

local function FlyTo(targetCFrame)
    local hrp = GetRoot()
    local hum = GetHum()
    if not hrp or not hum then return end
    
    SetAnchor(false) 
    hum.AutoRotate = false 
    
    local dist = (hrp.Position - targetCFrame.Position).Magnitude
    local speed = dist > 150 and 90 or 60 
    local duration = dist / speed
    
    local bv = Instance.new("BodyVelocity")
    bv.Velocity = Vector3.zero
    bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bv.Parent = hrp

    local info = TweenInfo.new(duration, Enum.EasingStyle.Linear)
    local tween = Services.TweenService:Create(hrp, info, {CFrame = targetCFrame})
    
    tween:Play()
    tween.Completed:Wait()
    
    if bv then bv:Destroy() end
    hum.AutoRotate = true
    SetAnchor(true) 
end

local function InstantTP(targetCFrame)
    SetAnchor(false)
    local hrp = GetRoot()
    if hrp then hrp.CFrame = targetCFrame end
    task.wait(0.5)
end

local function EquipTool(targetName)
    local hum = GetHum()
    local char = LocalPlayer.Character
    local backpack = LocalPlayer.Backpack

    if hum then hum:UnequipTools() end
    local targetTool = nil
    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA("Tool") and tool.Name:lower():find(targetName) then targetTool = tool; break end
    end
    if targetTool then targetTool.Parent = char else
        local slot = (targetName == "pick" or targetName == "axe") and 2 or 1
        local RE = NetPath:FindFirstChild("RE/EquipToolFromHotbar")
        if RE then RE:FireServer(slot) end
    end
    task.wait(0.8)
end

-- ====================================================
-- [SMART DETECT LOGIC]
-- ====================================================

local function CalculateSmartPosition(node)
    local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
    if not prompt then return nil end
    local part = prompt.Parent
    if not part then return nil end
    
    local cf = part.CFrame
    local pos = cf.Position
    local upVec = cf.UpVector 
    local dotY = upVec:Dot(Vector3.new(0, 1, 0))
    
    local finalPos
    if dotY > 0.7 then
        finalPos = pos + Vector3.new(0, 5.5, 0)
        return CFrame.lookAt(finalPos, pos) 
    elseif dotY < -0.7 then
        finalPos = pos - Vector3.new(0, 6.0, 0)
        return CFrame.lookAt(finalPos, pos)
    else
        finalPos = pos + (cf.LookVector * 4.5)
        local lookAtPos = Vector3.new(pos.X, finalPos.Y, pos.Z)
        return CFrame.lookAt(finalPos, lookAtPos)
    end
end

-- ====================================================
-- [MINING LOGIC]
-- ====================================================

local function ProcessFolder(folderName)
    local Islands = Services.Workspace:WaitForChild("Islands", 5)
    if not Islands then return false end -- Return false jika gagal load
    
    local targetFolder
    if folderName == "Lava" then
        targetFolder = Islands:FindFirstChild("Lava Basin") and Islands["Lava Basin"]:FindFirstChild("Crystals")
    elseif folderName == "Deep" then
        targetFolder = Islands:FindFirstChild("Crystal Depths") and Islands["Crystal Depths"]:FindFirstChild("Crystals")
    end

    if not targetFolder then return false end
    
    -- Cek apakah ada crystal
    local crystals = {}
    for _, v in ipairs(targetFolder:GetChildren()) do
        if v:FindFirstChildWhichIsA("ProximityPrompt", true) then
            table.insert(crystals, v)
        end
    end

    -- DETEKSI: Jika kosong, return false agar script tau ini ZONK
    if #crystals == 0 then 
        Notify(folderName.." Empty (Zonk)", Color3.fromRGB(255, 100, 100))
        return false 
    end

    -- Jika ada, mulai mining
    local hrp = GetRoot()
    if hrp then
        table.sort(crystals, function(a, b)
            local posA = a:IsA("Model") and a:GetPivot().Position or a.Position
            local posB = b:IsA("Model") and b:GetPivot().Position or b.Position
            return (hrp.Position - posA).Magnitude < (hrp.Position - posB).Magnitude
        end)
    end

    for i, node in ipairs(crystals) do
        if not States.AutoCrystal then break end 
        local prompt = node:FindFirstChildWhichIsA("ProximityPrompt", true)
        if prompt and prompt.Enabled then
            local targetCF = CalculateSmartPosition(node)
            if targetCF then
                Notify("Mining ["..i.."/"..#crystals.."]", Color3.fromRGB(255, 255, 255))
                FlyTo(targetCF) 
                SetAnchor(true)
                task.wait(0.2)
                fireproximityprompt(prompt)
                local sTime = tick()
                repeat task.wait(0.1) until not prompt.Parent or not prompt.Enabled or (tick() - sTime) > 8.5
            end
        end
    end
    return true -- Return true artinya ada crystal yang ditambang
end

-- ====================================================
-- [FISHING LOGIC]
-- ====================================================

local function StopFishing()
    States.IsFishing = false
    pcall(function()
        NetPath["RF/UpdateAutoFishingState"]:InvokeServer(false)
        NetPath["RF/CancelFishingInputs"]:InvokeServer()
    end)
end

local function PerformFishing()
    if States.IsMining or not States.AutoCrystal or States.IsFishing then return end
    States.IsFishing = true
    
    local hrp = GetRoot()
    -- Cek jika kita masih di area mining (jauh dari saved home), teleport balik dulu
    if States.SavedHomeCFrame and hrp then
        local dist = (hrp.Position - States.SavedHomeCFrame.Position).Magnitude
        if dist > 500 then
            Notify("Returning Home...", Color3.fromRGB(0, 255, 0))
            InstantTP(States.SavedHomeCFrame)
            task.wait(2)
        end
    end

    Notify("Fishing Mode Active", Color3.fromRGB(0, 180, 255))
    SetAnchor(true) 
    EquipTool("rod")

    while States.AutoCrystal and States.IsFishing and not States.IsMining do
        pcall(function()
            NetPath["RF/UpdateAutoFishingState"]:InvokeServer(true)
            NetPath["RF/ChargeFishingRod"]:InvokeServer()
            task.wait(1.5) 
            NetPath["RF/RequestFishingMinigameStarted"]:InvokeServer(-0.987, 0.5, os.time())
            task.wait(2.5) 
            NetPath["RF/CatchFishCompleted"]:InvokeServer()
        end)
        task.wait(0.5)
    end
    SetAnchor(false)
end

-- ====================================================
-- [MAIN ROUTINE]
-- ====================================================

local function FullMiningRoutine(forceStart)
    local hrp = GetRoot()
    if not hrp then return end
    
    if States.IsMining then return end -- Cegah double run
    
    StopFishing()
    States.IsMining = true
    
    -- Simpan posisi HANYA jika belum tersimpan atau run baru
    if not States.SavedHomeCFrame or forceStart then
        States.SavedHomeCFrame = hrp.CFrame
    end

    Notify("Checking Locations...", Color3.fromRGB(255, 255, 0))
    local NoClipLoop = EnableNoClip()
    EquipTool("pick") 
    
    local foundLava = false
    local foundDeep = false

    -- [1] CEK LAVA BASIN
    InstantTP(Locations.LavaBasin)
    Notify("Checking Lava Basin...", Color3.fromRGB(255, 150, 0))
    task.wait(2.0) 
    foundLava = ProcessFolder("Lava") -- Akan return false jika kosong

    -- [2] CEK CRYSTAL DEPTHS (Hanya jika AutoCrystal masih aktif)
    if States.AutoCrystal then
        InstantTP(Locations.CrystalDepths)
        Notify("Checking Deep Caverns...", Color3.fromRGB(0, 150, 255))
        task.wait(2.0)
        foundDeep = ProcessFolder("Deep") -- Akan return false jika kosong
    end
    
    -- [LOGIKA BALIK]
    if not foundLava and not foundDeep then
        Notify("ZONK! No Crystals Found.", Color3.fromRGB(255, 0, 0))
        task.wait(1)
    else
        Notify("Mining Cycle Done.", Color3.fromRGB(0, 255, 0))
    end
    
    -- Balik ke posisi awal
    if States.SavedHomeCFrame then
        Notify("Returning to Spot...", Color3.fromRGB(255, 255, 0))
        InstantTP(States.SavedHomeCFrame)
    end
    task.wait(2.0)
    
    if NoClipLoop then NoClipLoop:Disconnect() end
    SetAnchor(false)
    States.IsMining = false
    
    -- Lanjut Mancing
    EquipTool("rod")
    task.spawn(PerformFishing)
end

-- ====================================================
-- [INTELLIGENT BUTTON LOGIC]
-- ====================================================

ToggleBtn.MouseButton1Click:Connect(function()
    States.AutoCrystal = not States.AutoCrystal
    
    if States.AutoCrystal then
        ToggleBtn.Text = "SYSTEM ACTIVE"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
        
        -- [LOGIKA WAKTU SAAT KLIK]
        local now = os.date("!*t")
        local min = now.min
        
        -- Simpan posisi saat ini sebagai "Home"
        if GetRoot() then States.SavedHomeCFrame = GetRoot().CFrame end

        -- Cek apakah menit 0 - 45 (Waktu Mining)
        if min >= 0 and min <= 45 then
            Notify("Mining Time Detected!", Color3.fromRGB(255, 215, 0))
            task.spawn(function() FullMiningRoutine(true) end)
        else
            Notify("Not Mining Time. Fishing...", Color3.fromRGB(0, 200, 255))
            task.spawn(PerformFishing)
        end
        
    else
        ToggleBtn.Text = "START SYSTEM"
        ToggleBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
        Notify("System Stopped", Color3.fromRGB(255, 0, 0))
        States.IsMining = false
        StopFishing()
        SetAnchor(false)
    end
end)

-- [LOOP BACKGROUND UNTUK CEK JAM SECARA BERKALA]
task.spawn(function()
    while true do
        task.wait(10) -- Cek setiap 10 detik
        if States.AutoCrystal and not States.IsMining then
            local now = os.date("!*t")
            local min = now.min
            
            -- Jika masuk menit 00 (Awal jam mining) dan sedang mancing -> Pindah ke Mining
            if min >= 0 and min <= 5 and States.IsFishing then
                Notify("Scheduled Mining Started!", Color3.fromRGB(255, 215, 0))
                FullMiningRoutine(false)
            -- Jika sudah lewat menit 45 dan masih mancing -> Tetap mancing
            elseif min > 45 and not States.IsFishing then
                 task.spawn(PerformFishing)
            end
        end
    end
end)
